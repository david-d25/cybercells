(function(){"use strict";var e={969:function(e,t,n){var i=n(9197),s=n(8473),l=n(4188),o=n(5252);n(7658);function a(e){return[e.cyanPigment,e.magentaPigment,e.yellowPigment,e.whitePigment]}function r(e){const[t,n,i,s]=e,[l,o,a]=[1-t,1-n,1-i].map((e=>e+(1-e)*s/2)),r=1-(1-t)*(1-n)*(1-i)*(1-s);return[l,o,a,r]}function d(e,t){return[(e[0]+t[0])/2,(e[1]+t[1])/2,(e[2]+t[2])/2,(e[3]+t[3])/2]}function c(e,t){const n=1-t;return[e[0]*n,e[1]*n,e[2]*n,e[3]]}function u(e){return`rgba(${Math.floor(256*e[0])}, ${Math.floor(256*e[1])}, ${Math.floor(256*e[2])}, ${e[3]})`}const{sqrt:h,sin:m,cos:p,acos:g,PI:w}=Math;class f{constructor(e=0,t=0){(0,o.Z)(this,"x",void 0),(0,o.Z)(this,"y",void 0),this.x=e,this.y=t}get length(){return h(this.x*this.x+this.y*this.y)}plus(e){return e instanceof f?new f(this.x+e.x,this.y+e.y):new f(this.x+e,this.y+e)}minus(e){return e instanceof f?new f(this.x-e.x,this.y-e.y):new f(this.x-e,this.y-e)}times(e){return e instanceof f?new f(this.x*e.y,this.y*e.y):new f(this.x*e,this.y*e)}div(e){return e instanceof f?new f(this.x/e.y,this.x/e.y):new f(this.x/e,this.y/e)}get negative(){return new f(-this.x,-this.y)}dot(e){return this.x*e.x+this.y*e.y}to(e){return e.minus(this)}nearest(...e){return e.reduce(((e,t)=>this.distance(e)>this.distance(t)?t:e))}shortestAngularTurn(e){const t=e.angle-this.angle;return t<-w||t>=0&&t<w?1:-1}positiveAngleDiff(e){return(this.angle-e.angle+2*w)%(2*w)}get angle(){return-(this.y>0?2*w-g(this.x/this.length):g(this.x/this.length))}get angleSafe(){return 0!=this.length?this.angle:0}distance(e){return h((this.x-e.x)**2+(this.y-e.y)**2)}isNaN(){return isNaN(this.x)||isNaN(this.y)}rotate(e){return new f(this.x*p(e)-this.y*m(e),this.x*m(e)+this.y*p(e))}get unit(){return 0!=this.length?new f(this.x/this.length,this.y/this.length):new f(1,0)}static isNaN(e){return isNaN(e.x)||isNaN(e.y)}static unit(e){return new f(p(e),m(e))}static equals(e,t){return null==e&&null==t||null!=e&&null!=t&&(e.x==t.x&&e.y==t.y)}}class v{constructor(e,t){(0,o.Z)(this,"center",void 0),(0,o.Z)(this,"mass",void 0),(0,o.Z)(this,"id",-1),this.center=e,this.mass=t}get radius(){return Math.sqrt(this.mass/Math.PI)/v.FOOD_DENSITY}get aabb(){const e=this.radius;return[this.center.x-e,this.center.y-e,this.center.x+e,this.center.y+e]}}(0,o.Z)(v,"FOOD_DENSITY",3);class y{constructor(e,t,n,i,s,l){(0,o.Z)(this,"center",void 0),(0,o.Z)(this,"speed",void 0),(0,o.Z)(this,"mass",void 0),(0,o.Z)(this,"angle",void 0),(0,o.Z)(this,"angularSpeed",void 0),(0,o.Z)(this,"genome",void 0),(0,o.Z)(this,"id",-1),(0,o.Z)(this,"connections",new Map),(0,o.Z)(this,"age",0),this.center=e,this.speed=t,this.mass=n,this.angle=i,this.angularSpeed=s,this.genome=l}get radius(){return Math.sqrt(this.mass)}get aabb(){const e=this.radius;return[this.center.x-e,this.center.y-e,this.center.x+e,this.center.y+e]}applyImpulse(e,t){if(0==t.length)return;const n=e.to(this.center).angle,i=n-t.angle,s=this.center.distance(e),l=Math.sin(i)*s,o=1/(Math.pow(l/this.radius,2)+1),a=1-o;this.speed=this.speed.plus(t.times(o)),this.angularSpeed-=Math.atan(t.length/l)*a}}class b{constructor(e,t){(0,o.Z)(this,"angle",void 0),(0,o.Z)(this,"partnerId",void 0),this.angle=e,this.partnerId=t}}class S{constructor(e,t){(0,o.Z)(this,"a",void 0),(0,o.Z)(this,"b",void 0),(0,o.Z)(this,"id",-1),this.a=e,this.b=t}get aabb(){return[this.a.x,this.a.y,this.b.x,this.b.y]}}var x;(function(e){e[e["PHAGOCYTE"]=0]="PHAGOCYTE",e[e["FLAGELLOCYTE"]=1]="FLAGELLOCYTE"})(x||(x={}));var C,_=x;class M{constructor(e=_.PHAGOCYTE,t=0,n=0,i=0,s=0,l=0,a=0,r=0,d=0,c=0,u=!1,h=!1,m=!1,p=0){(0,o.Z)(this,"type",void 0),(0,o.Z)(this,"cyanPigment",void 0),(0,o.Z)(this,"magentaPigment",void 0),(0,o.Z)(this,"yellowPigment",void 0),(0,o.Z)(this,"whitePigment",void 0),(0,o.Z)(this,"hardness",void 0),(0,o.Z)(this,"splitMass",void 0),(0,o.Z)(this,"splitAngle",void 0),(0,o.Z)(this,"child1Angle",void 0),(0,o.Z)(this,"child2Angle",void 0),(0,o.Z)(this,"stickOnSplit",void 0),(0,o.Z)(this,"child1KeepConnections",void 0),(0,o.Z)(this,"child2KeepConnections",void 0),(0,o.Z)(this,"nutritionPriority",void 0),(0,o.Z)(this,"flagellumForce",8),(0,o.Z)(this,"children",[this,this]),this.type=e,this.cyanPigment=t,this.magentaPigment=n,this.yellowPigment=i,this.whitePigment=s,this.hardness=l,this.splitMass=a,this.splitAngle=r,this.child1Angle=d,this.child2Angle=c,this.stickOnSplit=u,this.child1KeepConnections=h,this.child2KeepConnections=m,this.nutritionPriority=p}deepCopy(){return this.copyRecursive()}applyRadiation(e,t){}static newNullGenome(){return new M}static newSampleGenome(){const e=new M;return e.type=_.PHAGOCYTE,e.hardness=.6,e.splitMass=420,e.child1KeepConnections=!0,e.child2KeepConnections=!0,e.nutritionPriority=1,[e.cyanPigment,e.magentaPigment,e.yellowPigment,e.whitePigment]=this.getRandomCellPigments(),e}static getRandomCellPigments(){const e=[Math.round(Math.random()/2*100)/100,Math.round(100*Math.random())/100,0,0];for(let t=0;t<e.length;t++){const n=Math.floor(Math.random()*e.length);[e[t],e[n]]=[e[n],e[t]]}return e}copyRecursive(e=(new Map).set(null,null)){const t=new M;return t.type=this.type,t.cyanPigment=this.cyanPigment,t.magentaPigment=this.magentaPigment,t.yellowPigment=this.yellowPigment,t.whitePigment=this.whitePigment,t.hardness=this.hardness,t.splitMass=this.splitMass,t.splitAngle=this.splitAngle,t.child1Angle=this.child1Angle,t.child2Angle=this.child2Angle,t.stickOnSplit=this.stickOnSplit,t.child1KeepConnections=this.child1KeepConnections,t.child2KeepConnections=this.child2KeepConnections,t.nutritionPriority=this.nutritionPriority,t.flagellumForce=this.flagellumForce,e.set(this,t),t.children=[e.has(this.children[0])?e.get(this.children[0]):this.children[0].copyRecursive(e),e.has(this.children[1])?e.get(this.children[1]):this.children[1].copyRecursive(e)],t}findAllGenomes(){const e=new Array,t=new Set;while(0!=e.length)e.pop().children.forEach((n=>{t.has(n)||(e.push(n),t.add(n))}));return t}applyRadiationRecursive(){}}class P{constructor(e,t){(0,o.Z)(this,"center",void 0),(0,o.Z)(this,"height",void 0),this.center=e,this.height=t}static createNull(){return new P(new f,0)}}class U{static findLineAndCircleIntersections(e,t,n,i){const s=n.x,l=n.y,o=i.x,a=i.y,r=e.x,d=e.y,c=o-s,u=a-l,h=s-r,m=l-d,p=c*c+u*u,g=2*(c*h+u*m),w=h*h+m*m-t*t,v=g*g-4*p*w;if(v<0)return[];const y=(-g-Math.sqrt(v))/(2*p),b=(-g+Math.sqrt(v))/(2*p),S=[];return y>=0&&y<=1&&S.push(new f(s+c*y,l+u*y)),b>=0&&b<=1&&S.push(new f(s+c*b,l+u*b)),S}static findCirclesIntersections(e,t,n,i){const s=e.x,l=e.y,o=t,a=n.x,r=n.y,d=i,c=a-s,u=r-l,h=Math.sqrt(c*c+u*u);if(0==h||h>o+d)return[];const m=(o*o-d*d+h*h)/(2*h),p=Math.sqrt(o*o-m*m);if(isNaN(p))return[];const g=s+c*m/h,w=l+u*m/h,v=g+p*u/h,y=g-p*u/h,b=w-p*c/h,S=w+p*c/h;return[new f(v,b),new f(y,S)]}static findLinesIntersection(e,t){const n=e[0].to(e[1]),i=t[0].to(t[1]),s=n.y/n.x,l=i.y/i.x;if(isNaN(s)||isNaN(l)||!isFinite(s)&&!isFinite(l)||s==l)return null;if(!isFinite(s))return U.findVerticalLineIntersection(e,t);if(!isFinite(l))return U.findVerticalLineIntersection(t,e);const o=e[0].y-s*e[0].x,a=t[0].y-l*t[0].x,r=new f((a-o)/(s-l),0);r.y=s*r.x+o;const d=e[0].to(r),c=t[0].to(r);return n.dot(d)>=0&&n.dot(d)<=n.dot(n)&&i.dot(c)>=0&&i.dot(c)<=i.dot(i)?r:null}static projectPointOntoLine(e,t){const n=t[0],i=t[1];return Math.abs(n.x-i.x)<Number.EPSILON?new f(n.x,e.y):n.to(i).times(n.to(e).dot(n.to(i))/n.to(i).dot(n.to(i))).plus(n)}static clamp(e,t,n){return Math.min(Math.max(e,t),n)}static shortestAngularTurn(e,t){const n=t-e;return Math.abs(n)<1e-8?0:n<-Math.PI||n>=0&&n<Math.PI?1:-1}static findVerticalLineIntersection(e,t){if(t[0].x==t[1].x)return null;const n=(t[1].y-t[0].y)/(t[1].x-t[0].x),i=t[0].y-n*t[0].x,s=new f(e[0].x,0);if(s.y=n*s.x+i,t[0].x<s.x&&t[1].x<s.x||t[0].x>s.x&&t[1].x>s.x)return null;const l=(e[0].y+e[1].y)/2,o=Math.abs(e[0].y-e[1].y);return Math.abs(s.y-l)<=o/2?s:null}}class I{constructor(){(0,o.Z)(this,"root",null)}}class Z{constructor(e,t,n=new Set){(0,o.Z)(this,"axis",void 0),(0,o.Z)(this,"aabb",void 0),(0,o.Z)(this,"objects",void 0),(0,o.Z)(this,"childA",null),(0,o.Z)(this,"childB",null),(0,o.Z)(this,"splitLine",0),this.axis=e,this.aabb=t,this.objects=n}}(function(e){e[e["X"]=0]="X",e[e["Y"]=1]="Y"})(C||(C={}));class k{constructor(){(0,o.Z)(this,"tree",new I)}buildSystem(e,t){const n=new Set;for(const i of t)n.add(i);this.tree.root=new Z(C.X,[0,0,e.width,e.height],n),this.buildNodes(this.tree.root,Math.floor(Math.sqrt(n.size)))}add(e){}remove(e){}findPotentialCollisions(e){const t=new Set;if(null==this.tree.root)return t;const n=[this.tree.root];while(0!=n.length){const i=n.pop();if(null==i.childA||null==i.childB)for(const e of i.objects)t.add(e);else{const t=i.splitLine,[s,l,o,a]=e;i.axis==C.X?(s<=t&&n.push(i.childA),o>=t&&n.push(i.childB)):(l<=t&&n.push(i.childA),a>=t&&n.push(i.childB))}}return t}buildNodes(e,t){let n=0,i=0;const s=e.axis==C.X;if(s)for(const w of e.objects)n+=w.aabb[0],i++;else for(const w of e.objects)n+=w.aabb[1],i++;if(n/=i,i<=2||t<=0)return;const[l,o,a,r]=e.aabb,d=new Set,c=new Set,u=[l,o,s?n:a,s?r:n],h=[s?n:l,s?o:n,a,r];if(s)for(const w of e.objects)w.aabb[0]<=n&&d.add(w),w.aabb[2]>=n&&c.add(w);else for(const w of e.objects)w.aabb[1]<=n&&d.add(w),w.aabb[3]>=n&&c.add(w);e.splitLine=n;const m=s?C.Y:C.X,p=new Z(m,u,d),g=new Z(m,h,c);this.buildNodes(p,t-1),this.buildNodes(g,t-1)}}class T{constructor(e,t){(0,o.Z)(this,"width",void 0),(0,o.Z)(this,"height",void 0),(0,o.Z)(this,"food",new Map),(0,o.Z)(this,"cells",new Map),(0,o.Z)(this,"walls",new Map),(0,o.Z)(this,"foodSpawnRate",0),(0,o.Z)(this,"lightIntensity",0),(0,o.Z)(this,"radiation",0),(0,o.Z)(this,"viscosity",0),(0,o.Z)(this,"density",0),(0,o.Z)(this,"gravity",new f),(0,o.Z)(this,"camera",P.createNull()),(0,o.Z)(this,"maxNutritionGainSpeed",56),(0,o.Z)(this,"minCellMass",80),(0,o.Z)(this,"maxCellMass",500),(0,o.Z)(this,"foodMassLoss",.1),(0,o.Z)(this,"minFoodMass",.1),(0,o.Z)(this,"flagellocyteFlagellumForceCost",.1),(0,o.Z)(this,"flagellocyteFlagellumForceMax",10),(0,o.Z)(this,"idCounter",0),(0,o.Z)(this,"cellCollisionSystem",new k),(0,o.Z)(this,"foodCollisionSystem",new k),(0,o.Z)(this,"wallCollisionSystem",new k),this.width=e,this.height=t}newId(){return this.idCounter++}add(e){-1==e.id&&(e.id=this.newId()),e instanceof y&&this.cells.set(e.id,e),e instanceof v&&this.food.set(e.id,e),e instanceof S&&this.walls.set(e.id,e)}remove(e){if(this.cells.delete(e.id),this.food.delete(e.id),this.walls.delete(e.id),e instanceof y)for(const t of e.connections.keys())this.cells.get(t)?.connections.delete(e.id)}getLightIntensityAtPoint(e){}getRadiationIntensityAtPoint(e){}updateCollisionSystem(){this.cellCollisionSystem.buildSystem(this,this.cells.values()),this.foodCollisionSystem.buildSystem(this,this.food.values()),this.wallCollisionSystem.buildSystem(this,this.walls.values())}rayCast(e,t){const n=[];for(const i of this.walls.values())U.findLinesIntersection([i.a,i.b],[e,t])&&n.push(i);for(const i of this.cells.values())0!=U.findLineAndCircleIntersections(i.center,i.radius,e,t).length&&n.push(i);for(const i of this.food.values())0!=U.findLineAndCircleIntersections(i.center,i.radius,e,t).length&&n.push(i);return n}circleCast(e,t){const n=[],i=[e.x-t,e.y-t,e.x+t,e.y+t];for(const s of this.wallCollisionSystem.findPotentialCollisions(i))0!=U.findLineAndCircleIntersections(e,t,s.a,s.b).length&&n.push(s);for(const s of this.cellCollisionSystem.findPotentialCollisions(i))0!=U.findCirclesIntersections(e,t,s.center,s.radius).length&&n.push(s);for(const s of this.foodCollisionSystem.findPotentialCollisions(i))0!=U.findCirclesIntersections(e,t,s.center,s.radius).length&&n.push(s);return n}pointCast(e,t){const n=[],i=1e-5,s=[e.x-t,e.y-t,e.x+t,e.y+t];for(const l of this.wallCollisionSystem.findPotentialCollisions(s)){const s=U.projectPointOntoLine(e,[l.a,l.b]);e.distance(s)<=t&&s.distance(l.a)+s.distance(l.b)<=l.a.distance(l.b)+2*t+i&&n.push(l)}for(const l of this.cellCollisionSystem.findPotentialCollisions(s))l.center.distance(e)<=l.radius+t&&n.push(l);for(const l of this.foodCollisionSystem.findPotentialCollisions(s))l.center.distance(e)<=l.radius+t&&n.push(l);return n}clear(){this.cells.forEach(this.remove.bind(this)),this.food.forEach(this.remove.bind(this)),this.walls.forEach(this.remove.bind(this))}static getDefault(){return new T(0,0)}}(0,o.Z)(T,"TEMPORARY_DEBUG",(()=>{const e=new T(200,200);e.viscosity=.1,e.foodSpawnRate=10,e.camera=new P(new f(0,0),800),e.gravity=new f(0,0);for(let t=0;t<40;t++){const t=M.newSampleGenome();e.add(new y(new f(e.width*Math.random(),e.height*Math.random()),new f,400,0,0,t))}for(let t=0;t<100;t++)e.add(new v(new f(e.width*Math.random(),e.height*Math.random()),50));return e.camera.center=new f(e.width/2,e.height/2),e.camera.height=1.5*e.height,e.add(new S(new f(0,0),new f(0,e.height))),e.add(new S(new f(0,e.height),new f(e.width,e.height))),e.add(new S(new f(e.width,e.height),new f(e.width,0))),e.add(new S(new f(e.width,0),new f(0,0))),e.updateCollisionSystem(),e})());function A(e){const t=e[0],n=e[1],i=e[2],s=e[3],l=e[4],o=e[5],a=t*s-n*i;if(0===a)throw Error("Matrix has zero determinant");return[s/a,-n/a,-i/a,t/a,(i*o-s*l)/a,(n*l-t*o)/a]}function E(e,t){const n=e[0],i=e[1];return[t[0]*n+t[2]*i+t[4],t[1]*n+t[3]*i+t[5]]}class W{constructor(e,t=T.getDefault()){(0,o.Z)(this,"canvas",void 0),(0,o.Z)(this,"world",void 0),(0,o.Z)(this,"startTime",Date.now()),(0,o.Z)(this,"context",void 0),(0,o.Z)(this,"config",{layers:{background:!0,walls:!0,cells:!0,food:!0}}),this.canvas=e,this.world=t,this.context=e.getContext("2d")}render(){this.clearScene(),this.context.save(),this.applyCameraTransform(),this.config.layers.background&&this.renderBackground(),this.config.layers.food&&this.renderFood(),this.config.layers.cells&&this.renderCells(),this.config.layers.walls&&this.renderWalls(),this.context.restore()}setWorld(e){this.world=e}project(e){return E(e,this.buildCameraTransform())}unproject(e){const t=this.buildCameraTransform(),n=A(t);return E(e,n)}clearScene(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}applyCameraTransform(){this.context.setTransform(...this.buildCameraTransform())}renderFood(){const e=this.context;e.fillStyle="rgb(168, 105, 33)",this.world.food.forEach((t=>{e.beginPath(),e.arc(t.center.x,t.center.y,t.radius,0,2*Math.PI),e.fill()}))}renderWalls(){const e=this.context;e.strokeStyle="black",e.lineCap="round",e.lineWidth=2,e.beginPath(),this.world.walls.forEach((t=>{e.moveTo(t.a.x,t.a.y),e.lineTo(t.b.x,t.b.y)})),e.stroke()}renderCells(){const e=this.context;this.world.cells.forEach((t=>{const n=t.aabb,[[i,s],[l,o]]=[this.project([n[0],n[1]]),this.project([n[2],n[3]])];if(l<0||o<0||i>this.canvas.width||s>this.canvas.height)return;const d=r(a(t.genome)),h=c(d,.3),m=h,p=1.5,g=t.radius-p,w=t.radius-p/2,v=this.calculateCellObstacles(t),y=v.map((e=>{const n=new f(e[0],e[1]).to(t.center).unit.times(p),i=new f(e[2],e[3]).to(t.center).unit.times(p);return[e[0]+n.x,e[1]+n.y,e[2]+i.x,e[3]+i.y]})),b=v.map((e=>{const n=new f(e[0],e[1]).to(t.center).unit.times(p/2),i=new f(e[2],e[3]).to(t.center).unit.times(p/2);return[e[0]+n.x,e[1]+n.y,e[2]+i.x,e[3]+i.y]}));if(e.fillStyle=u(d),e.beginPath(),0==y.length)e.arc(t.center.x,t.center.y,g,0,2*Math.PI);else{e.moveTo(y[0][0],y[0][1]);for(let n=0;n<y.length;n++){const i=y[n],s=y[(n+1)%y.length];if(e.lineTo(i[2],i[3]),i[2]!=s[0]||i[3]!=s[1]){const n=t.center.to(new f(i[2],i[3])).angle,l=t.center.to(new f(s[0],s[1])).angle;e.arc(t.center.x,t.center.y,g,n,l)}}}if(e.fill(),e.strokeStyle=u(h),e.lineCap="round",e.lineWidth=p,e.beginPath(),0==b.length)e.arc(t.center.x,t.center.y,w,0,2*Math.PI);else{e.moveTo(b[0][0],b[0][1]);for(let n=0;n<b.length;n++){const i=b[n],s=b[(n+1)%b.length];if(e.lineTo(i[2],i[3]),i[2]!=s[0]||i[3]!=s[1]){const n=t.center.to(new f(i[2],i[3])).angle,l=t.center.to(new f(s[0],s[1])).angle;e.arc(t.center.x,t.center.y,w,n,l)}}}e.stroke(),e.fillStyle=u(m),e.beginPath(),e.arc(t.center.x,t.center.y,Math.sqrt(t.radius),0,2*Math.PI),e.fill()})),this.world.cells.forEach((e=>this.renderCellConnections(e)))}renderCellConnections(e){const t=this.context;e.connections.forEach((n=>{const i=n.partnerId;if(i<e.id)return;const s=this.world.cells.get(i),l=s.connections.get(e.id);for(let o=0;o<4;o++){const i=o*Math.PI/24-1.5*Math.PI/24,h=e.center.plus(f.unit(e.angle+n.angle+i).times(.5*e.radius)),m=s.center.plus(f.unit(s.angle+l.angle-i).times(.5*s.radius)),p=t.createLinearGradient(h.x,h.y,m.x,m.y),g=c(r(a(e.genome)),.3),w=c(r(a(s.genome)),.3),v=c(d(g,w),.2);p.addColorStop(0,"transparent"),p.addColorStop(.5,u(v)),p.addColorStop(1,"transparent"),t.fillStyle=p;const y=e.center.plus(f.unit(e.angle+n.angle+2*i+Math.PI/45).times(.7*e.radius)),b=s.center.plus(f.unit(s.angle+l.angle-2*i-Math.PI/45).times(.7*s.radius)),S=e.center.plus(f.unit(e.angle+n.angle+2*i-Math.PI/45).times(.7*e.radius)),x=s.center.plus(f.unit(s.angle+l.angle-2*i+Math.PI/45).times(.7*s.radius));t.beginPath(),t.moveTo(h.x,h.y),t.bezierCurveTo(y.x,y.y,b.x,b.y,m.x,m.y),t.bezierCurveTo(x.x,x.y,S.x,S.y,h.x,h.y),t.fill()}}))}renderBackground(){const e=this.context;e.save(),e.resetTransform(),e.fillStyle="rgb(36, 36, 36)",e.fillRect(0,0,this.canvas.width,this.canvas.height),e.restore(),e.fillStyle="rgb(51, 51, 51)",e.fillRect(0,0,this.world.width,this.world.height)}calculateCellObstacles(e){const t=[],n=[];this.world.circleCast(e.center,e.radius).forEach((i=>{if(i==e)return;let s;if(i instanceof S){if(s=U.findLineAndCircleIntersections(e.center,e.radius,i.a,i.b),1==s.length){const t=e.center.distance(i.a),n=e.center.distance(i.b);s.push(t<n?i.a:i.b)}}else{if(!(i instanceof y))return;s=U.findCirclesIntersections(e.center,e.radius,i.center,i.radius)}if(2!=s.length)return;let[l,o,a,r]=[s[0].x,s[0].y,s[1].x,s[1].y];1==e.center.to(new f(a,r)).shortestAngularTurn(e.center.to(new f(l,o)))&&([l,o,a,r]=[a,r,l,o]);const d=e.center.to(new f(l,o)),c=e.center.to(new f(a,r));let u=d.length,h=c.length;if(0==u||0==h)return;let m=d.angle,p=c.angle,g=t.length;for(let e=0;e<t.length;e++)if(m<=t[e][1]){g=e;break}for(let w=0;n.length>0&&w<t.length+1;w++){const i=n[(w+n.length)%n.length],s=t[(w+n.length)%n.length],d=U.findLinesIntersection([new f(i[0],i[1]),new f(i[2],i[3])],[new f(l,o),new f(a,r)]);if(d){const t=e.center.to(d),n=s[1]-m,c=n<-Math.PI||n>=0&&n<Math.PI?1:-1;1==c?(a=d.x,r=d.y,p=t.angle,h=t.length,i[0]=d.x,i[1]=d.y,s[0]=h,s[1]=p):(l=d.x,o=d.y,m=t.angle,u=t.length,i[2]=d.x,i[3]=d.y,s[2]=u,s[3]=m)}}t.splice(g,0,[u,m,h,p]),n.splice(g,0,[l,o,a,r])}));for(let i=0;i<n.length;i++){const s=n[i],l=t[i];for(let o=0;o<n.length;o++){if(i==o)continue;const a=n[o],r=t[o];if(Math.abs(l[3]-r[1])>1e-8&&U.shortestAngularTurn(l[1],r[1])>=0&&1==U.shortestAngularTurn(l[1],r[3])&&-1==U.shortestAngularTurn(l[3],r[1])){const d=null!=U.findLinesIntersection([e.center,new f(a[0],a[1])],[new f(s[0],s[1]),new f(s[2],s[3])]);if(-1==U.shortestAngularTurn(l[3],r[3]))if(d){const e=o;e<=i&&i--,o--,n.splice(e,1),t.splice(e,1)}else{const a=U.findLinesIntersection([e.center,f.unit(r[1]).times(e.radius)],[new f(s[0],s[1]),new f(s[2],s[3])]),d=U.findLinesIntersection([e.center,f.unit(r[3]).times(e.radius)],[new f(s[0],s[1]),new f(s[2],s[3])]);if(null==a||null==d)break;const c=[d.x,d.y,s[2],s[3]],u=[e.center.distance(d),r[3],l[2],l[3]];s[2]=a.x,s[3]=a.y,l[2]=e.center.distance(a),l[3]=r[1];const h=o+1;n.splice(h,0,c),t.splice(h,0,u),h<=i&&i++}else if(d){const s=U.findLinesIntersection([e.center,e.center.plus(f.unit(l[3]).times(e.radius))],[new f(a[0],a[1]),new f(a[2],a[3])]);if(null==s)break;a[0]=s.x,a[1]=s.y,r[0]=e.center.distance(s),r[1]=l[3],new f(a[0],a[1]).distance(new f(a[2],a[3]))<1e-6&&(o<=i&&i--,n.splice(o,1),t.splice(o,1),o--)}else{const a=U.findLinesIntersection([e.center,e.center.plus(f.unit(r[1]).times(e.radius))],[new f(s[0],s[1]),new f(s[2],s[3])]);if(null==a)break;s[2]=a.x,s[3]=a.y,l[2]=e.center.distance(a),l[3]=r[1],new f(s[0],s[1]).distance(new f(s[2],s[3]))<1e-6&&(i<=o&&o--,n.splice(i,1),t.splice(i,1),i--)}}}}return n}buildCameraTransform(){const e=this.canvas.width,t=this.canvas.height,n=this.world.camera,i=0!=t?t/n.height:1;return[i,0,0,i,-n.center.x*i+e/2,-n.center.y*i+t/2]}}class V{constructor(e,t,n,i,s,l){(0,o.Z)(this,"world",void 0),(0,o.Z)(this,"type",void 0),(0,o.Z)(this,"screenX",void 0),(0,o.Z)(this,"screenY",void 0),(0,o.Z)(this,"worldX",void 0),(0,o.Z)(this,"worldY",void 0),this.world=e,this.type=t,this.screenX=n,this.screenY=i,this.worldX=s,this.worldY=l}}const L=["onTouchstart","onTouchmove","onTouchend","onWheel"];var D=(0,s.aZ)({__name:"WorldViewer",setup(e,{emit:t}){const n=.005,o=(0,l.iH)(),a=(0,l.iH)();let r,d,c,u,h,m=(0,s.f3)("world");const p={dragged:!1,mouseDown:!1,lastMouseWorldPoint:[0,0]};function g(e){const t=m.camera;e.deltaY>0?t.height*=1+e.deltaY*n:t.height*=1/(1-e.deltaY*n),t.height<1&&(t.height=1)}function w(e){if(1==e.touches.length){let n;switch(e.type){case"touchstart":n="mousedown";break;case"touchmove":n="mousemove";break;case"touchend":n="mouseup";break}if(n){const{clientX:i,clientY:s}=e.touches[0],l=window.devicePixelRatio,[o,a]=[i*l,s*l];let[r,d]=c.unproject([o,a]);const u=new V(m,`world-${n}`,o,a,r,d);v(u),t(u.type,u)}}}function f(e){if("click"===e.type&&p.dragged)return;const n=window.devicePixelRatio,[i,s]=[e.x*n,e.y*n];let[l,o]=c.unproject([i,s]);const a=new V(m,`world-${e.type}`,i,s,l,o);v(a),t(a.type,a)}function v(e){if("world-mousedown"===e.type&&(p.mouseDown=!0,p.dragged=!1,p.lastMouseWorldPoint=[e.worldX,e.worldY]),"world-mousemove"===e.type&&p.mouseDown){p.dragged=!0;const[t,n]=p.lastMouseWorldPoint;m.camera.center.x+=t-e.worldX,m.camera.center.y+=n-e.worldY,[e.worldX,e.worldY]=c.unproject([e.screenX,e.screenY]),p.lastMouseWorldPoint=[e.worldX,e.worldY]}"world-mouseup"!==e.type&&"world-mouseleave"!==e.type||(p.mouseDown=!1)}function y(){c.render(),h=window.requestAnimationFrame(y)}function b(){const e=window.devicePixelRatio,{width:t,height:n}=d.getBoundingClientRect();r.width=Math.round(t*e),r.height=Math.round(n*e),c.render()}return(0,s.bv)((()=>{r=o.value,d=a.value,c=new W(r,m),u=new ResizeObserver(b),u.observe(r),y()})),(0,s.Jd)((()=>{u.disconnect(),window.cancelAnimationFrame(h)})),(e,t)=>((0,s.wg)(),(0,s.iD)("div",{class:"c-world-viewer",ref_key:"containerRef",ref:a},[(0,s._)("canvas",{class:"canvas",ref_key:"canvasRef",ref:o,onClick:f,onMousedown:f,onMouseup:f,onMousemove:f,onMouseleave:f,onTouchstart:(0,i.iM)(w,["prevent"]),onTouchmove:(0,i.iM)(w,["prevent"]),onTouchend:(0,i.iM)(w,["prevent"]),onWheel:(0,i.iM)(g,["prevent"])},null,40,L)],512))}});const N=D;var O=N,R=n.p+"img/genome-editor.cd1de275.svg",F=n.p+"img/settings.7da3e4cd.svg",Y=n(4887);const G={class:"c-tabbed-panel"},B={class:"tabs"},H={class:"body"};var j=(0,s.aZ)({__name:"PropertiesTabbedPanel",setup(e){const t=(0,l.iH)(null),n=320;let i=0;const o=(0,l.iH)(300),a=(0,l.iH)(o.value);function r(e){i=e.clientX,d()}function d(){window.addEventListener("mousemove",c),window.addEventListener("mouseleave",u),window.addEventListener("mouseup",u)}function c(e){if(0===e.screenX)return;let t=i-e.clientX;a.value=o.value+t,a.value<n&&(a.value=n)}function u(){o.value=a.value,window.removeEventListener("mousemove",c),window.removeEventListener("mouseleave",u),window.removeEventListener("mouseup",u)}return(0,s.JJ)("activeTabName",t),(e,t)=>((0,s.wg)(),(0,s.iD)("div",G,[(0,s._)("div",{class:"tabbed-panel",draggable:"false",style:(0,Y.j5)({width:`${a.value}px`,minWidth:`${n}px`})},[(0,s._)("div",B,[(0,s.WI)(e.$slots,"tabs")]),(0,s._)("div",H,[(0,s.WI)(e.$slots,"bodies"),(0,s._)("div",{class:"resize-handle",onMousedown:r},null,32)])],4)]))}});const K=j;var X=K;const q=["disabled"];var $=(0,s.aZ)({__name:"HudButton",props:{active:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},borderRadius:{default:"4px"},borderWidth:{default:"1px"}},setup(e){const t=e;(0,i.sj)((e=>({"70e98800":(0,l.SU)(n),"69d2b898":(0,l.SU)(o)})));let n=(0,s.Fl)((()=>t.borderRadius.replaceAll("default","4px"))),o=(0,s.Fl)((()=>t.borderWidth.replaceAll("default","1px")));return(t,n)=>((0,s.wg)(),(0,s.iD)("button",{class:(0,Y.C_)(["c-button",{active:e.active}]),disabled:e.disabled},[(0,s.WI)(t.$slots,"default")],10,q))}});const J=$;var z=J,Q=(0,s.aZ)({__name:"PropertiesTab",props:["name"],setup(e){const t=e,n=(0,s.f3)("activeTabName");function i(){n.value==t.name?n.value=null:n.value=t.name}return(t,o)=>((0,s.wg)(),(0,s.j4)(z,{class:"c-properties-tab",active:(0,l.SU)(n)===e.name,onClick:i},{default:(0,s.w5)((()=>[(0,s.WI)(t.$slots,"default")])),_:3},8,["active"]))}});const ee=Q;var te=ee;const ne={class:"body-wr"};var ie=(0,s.aZ)({__name:"PropertiesTabBody",props:["name"],setup(e){const t=e,n=(0,s.f3)("activeTabName",(0,l.iH)(null));return(e,o)=>(0,s.wy)(((0,s.wg)(),(0,s.iD)("div",ne,[(0,s.WI)(e.$slots,"default")],512)),[[i.F8,(0,l.SU)(n)===t.name]])}});const se=ie;var le=se;const oe={class:"section-wr"},ae={key:0,class:"section-title"},re={class:"section-content"};var de=(0,s.aZ)({__name:"PropertiesSection",props:["title"],setup(e){const t=e;return(e,n)=>((0,s.wg)(),(0,s.iD)("div",oe,[t.title?((0,s.wg)(),(0,s.iD)("div",ae,(0,Y.zw)(t.title),1)):(0,s.kq)("",!0),(0,s._)("div",re,[(0,s.WI)(e.$slots,"default")])]))}}),ce=n(5312);const ue=(0,ce.Z)(de,[["__scopeId","data-v-35a5d221"]]);var he=ue;const me={class:"c-number-slider"},pe=["disabled","min","max","step"];var ge=(0,s.aZ)({__name:"NumberSlider",props:{min:null,max:null,step:null,disabled:{type:Boolean},modelValue:null},emits:["update:modelValue"],setup(e,{emit:t}){const n=e,o=(0,l.iH)(n.modelValue||0);return(0,s.YP)(n,(()=>{null!=n.modelValue&&(o.value=n.modelValue)})),(0,s.YP)(o,(()=>{t("update:modelValue",o.value)})),(t,n)=>((0,s.wg)(),(0,s.iD)("div",me,[(0,s.wy)((0,s._)("input",{class:"input",type:"range",disabled:e.disabled,min:e.min,max:e.max,step:e.step,"onUpdate:modelValue":n[0]||(n[0]=e=>o.value=e)},null,8,pe),[[i.nr,o.value]])]))}});const we=(0,ce.Z)(ge,[["__scopeId","data-v-39e8fa0e"]]);var fe=we;const ve={class:"c-slider-with-number-input"},ye={class:"slider-with-number-input"},be=["disabled"];var Se=(0,s.aZ)({__name:"SliderWithNumberInput",props:{min:null,max:null,step:null,disabled:{type:Boolean},modelValue:null},emits:["update:modelValue"],setup(e,{emit:t}){const n=e,o=(0,l.iH)(),a=(0,l.iH)(n.modelValue||0);return(0,s.YP)(n,(()=>{null!=n.modelValue&&(a.value=n.modelValue)})),(0,s.YP)(a,(()=>{t("update:modelValue",a.value)})),(t,n)=>((0,s.wg)(),(0,s.iD)("div",ve,[(0,s._)("div",ye,[(0,s.Wm)(fe,{class:"slider",min:e.min,max:e.max,step:e.step,disabled:e.disabled,modelValue:a.value,"onUpdate:modelValue":n[0]||(n[0]=e=>a.value=e),modelModifiers:{number:!0}},null,8,["min","max","step","disabled","modelValue"]),(0,s.wy)((0,s._)("input",{class:"text-input",type:"text",ref_key:"textInput",ref:o,"onUpdate:modelValue":n[1]||(n[1]=e=>a.value=e),disabled:e.disabled,onFocus:n[2]||(n[2]=e=>(0,l.SU)(o).select()),onKeydown:[n[3]||(n[3]=(0,i.D2)((e=>(0,l.SU)(o).blur()),["enter"])),n[4]||(n[4]=(0,i.D2)((e=>(0,l.SU)(o).blur()),["esc"]))]},null,40,be),[[i.nr,a.value,void 0,{number:!0}]])])]))}});const xe=Se;var Ce=xe;const _e={class:"c-input-label"};function Me(e,t){return(0,s.wg)(),(0,s.iD)("div",_e,[(0,s.WI)(e.$slots,"default")])}const Pe={},Ue=(0,ce.Z)(Pe,[["render",Me]]);var Ie=Ue,Ze=(0,s.aZ)({__name:"WorldSettings",setup(e){const t=(0,s.f3)("world");return(e,n)=>((0,s.wg)(),(0,s.j4)(he,{class:"c-world-settings-tab-body",title:"World settings"},{default:(0,s.w5)((()=>[(0,s.Wm)(Ie,null,{default:(0,s.w5)((()=>[(0,s.Uk)("Gravity")])),_:1}),(0,s.Wm)(Ce,{class:"slider-input",min:-5,max:5,step:.01,modelValue:(0,l.SU)(t).gravity.y,"onUpdate:modelValue":n[0]||(n[0]=e=>(0,l.SU)(t).gravity.y=e),modelModifiers:{number:!0}},null,8,["step","modelValue"]),(0,s.Wm)(Ie,null,{default:(0,s.w5)((()=>[(0,s.Uk)("Density")])),_:1}),(0,s.Wm)(Ce,{class:"slider-input",min:0,max:1.5,step:.01,modelValue:(0,l.SU)(t).density,"onUpdate:modelValue":n[1]||(n[1]=e=>(0,l.SU)(t).density=e),modelModifiers:{number:!0},disabled:!0},null,8,["max","step","modelValue"]),(0,s.Wm)(Ie,null,{default:(0,s.w5)((()=>[(0,s.Uk)("Viscosity")])),_:1}),(0,s.Wm)(Ce,{class:"slider-input",min:0,max:.8,step:.01,modelValue:(0,l.SU)(t).viscosity,"onUpdate:modelValue":n[2]||(n[2]=e=>(0,l.SU)(t).viscosity=e),modelModifiers:{number:!0}},null,8,["max","step","modelValue"]),(0,s.Wm)(Ie,null,{default:(0,s.w5)((()=>[(0,s.Uk)("Light intensity")])),_:1}),(0,s.Wm)(Ce,{class:"slider-input",min:0,max:.8,step:.01,modelValue:(0,l.SU)(t).lightIntensity,"onUpdate:modelValue":n[3]||(n[3]=e=>(0,l.SU)(t).lightIntensity=e),modelModifiers:{number:!0},disabled:!0},null,8,["max","step","modelValue"]),(0,s.Wm)(Ie,null,{default:(0,s.w5)((()=>[(0,s.Uk)("Food spawn rate")])),_:1}),(0,s.Wm)(Ce,{class:"slider-input",min:0,max:100,step:.01,modelValue:(0,l.SU)(t).foodSpawnRate,"onUpdate:modelValue":n[4]||(n[4]=e=>(0,l.SU)(t).foodSpawnRate=e),modelModifiers:{number:!0}},null,8,["step","modelValue"])])),_:1}))}});const ke=Ze;var Te=ke;const Ae={class:"c-cell-genome-preview"};var Ee=(0,s.aZ)({__name:"CellGenomePreview",props:{genome:null},setup(e){const t=e,n=(0,l.iH)();let i,o,a=T.getDefault();function r(){if(a.clear(),t.genome){const e=new y(new f,new f,300,Math.PI/4,0,t.genome);a.add(e),a.camera=new P(new f,3*e.radius)}}function d(){const e=window.devicePixelRatio,{width:t,height:i}=n.value.getBoundingClientRect();n.value.width=Math.round(t*e),n.value.height=Math.round(i*e),o.render()}return(0,s.bv)((()=>{o=new W(n.value,a),o.config.layers.background=!1,i=new ResizeObserver(d),i.observe(n.value),r(),o.render()})),(0,s.Jd)((()=>{i.disconnect()})),(0,s.YP)(t,(()=>{r(),o.render()})),(e,t)=>((0,s.wg)(),(0,s.iD)("div",Ae,[(0,s._)("canvas",{class:"canvas",ref_key:"canvas",ref:n},null,512)]))}});const We=Ee;var Ve=We;const Le={class:"c-genome-selector"},De={class:"select-head"},Ne=["onKeydown"],Oe={class:"dropdown"},Re=["onClick"],Fe={class:"dropdown-item__preview-wr"},Ye={class:"dropdown-item__name"},Ge=(0,s._)("div",{class:"dropdown-item__controls"},null,-1),Be=(0,s._)("div",{class:"new-item-button"},null,-1);var He=(0,s.aZ)({__name:"GenomeSelector",props:{library:null,disabled:{type:Boolean,default:!1},modelValue:null},emits:["update:modelValue"],setup(e,{emit:t}){const n=e,o=(0,l.iH)(n.modelValue?n.modelValue.name:""),a=(0,l.iH)(!1),r=(0,l.iH)(null),d=(0,s.Fl)((()=>r.value&&o.value===r.value.name?n.library.entries:n.library.search(o.value)));function c(e){a.value=!0;const t=e.target;t.select()}function u(e){r.value=e,a.value=!1}function h(){a.value=!1,m()}function m(){null==r.value?o.value="":o.value=r.value.name}return(0,s.YP)(r,(()=>{t("update:modelValue",r.value),m()})),(0,s.YP)(n,(()=>{n.modelValue&&(r.value=n.modelValue),m()})),(t,n)=>{const m=(0,s.Q2)("click-outside");return(0,s.wg)(),(0,s.iD)("div",Le,[(0,s.wy)(((0,s.wg)(),(0,s.iD)("div",{class:(0,Y.C_)({"dropdown-opened":a.value})},[(0,s._)("div",De,[r.value?((0,s.wg)(),(0,s.j4)(Ve,{key:0,class:"select-head__preview",genome:e.modelValue?.genome},null,8,["genome"])):(0,s.kq)("",!0),(0,s.wy)((0,s._)("input",{class:"select-head__name-input",placeholder:"Select genome","onUpdate:modelValue":n[0]||(n[0]=e=>o.value=e),onFocus:c,onKeydown:(0,i.D2)(h,["esc"])},null,40,Ne),[[i.nr,o.value]]),(0,s._)("button",{class:"select-head__dropdown-trigger",onClick:n[1]||(n[1]=e=>a.value=!a.value)})]),(0,s.wy)((0,s._)("div",Oe,[((0,s.wg)(!0),(0,s.iD)(s.HY,null,(0,s.Ko)((0,l.SU)(d),(e=>((0,s.wg)(),(0,s.iD)("div",{class:"dropdown-item",key:e.name,onClick:()=>u(e)},[(0,s._)("div",Fe,[(0,s.Wm)(Ve,{class:"dropdown-item__preview",genome:e.genome},null,8,["genome"])]),(0,s._)("div",Ye,(0,Y.zw)(e.name),1),Ge],8,Re)))),128)),Be],512),[[i.F8,a.value]])],2)),[[m,h]])])}}});const je=He;var Ke=je;const Xe={class:"c-properties-subheader"},qe={class:"text"};function $e(e,t){return(0,s.wg)(),(0,s.iD)("div",Xe,[(0,s._)("span",qe,[(0,s.WI)(e.$slots,"default")])])}const Je={},ze=(0,ce.Z)(Je,[["render",$e]]);var Qe=ze;const et={class:"c-genome-pigment-color-droplet-icon"};var tt=(0,s.aZ)({__name:"GenomePigmentColorDropletIcon",props:{color:{type:String,default:"white"},value:{type:Number,default:1}},setup(e){const t=e,n=(0,l.iH)();let i,o=null;function a(){i=new ResizeObserver(d),i.observe(n.value)}function r(){i.disconnect()}function d(){const e=n.value,t=window.devicePixelRatio,{width:i,height:s}=e.getBoundingClientRect();e.width=Math.round(i*t),e.height=Math.round(s*t),c()}function c(){const e=n.value,{width:i,height:s}=e;o=o||e.getContext("2d");const l=o.createLinearGradient(.5*i,.2*s,.5*i,.85*s),a=Math.min(1,Math.max(0,t.value));l.addColorStop(0,"transparent"),l.addColorStop(1-a,"transparent"),l.addColorStop(1-a,t.color),l.addColorStop(1,t.color),o.clearRect(0,0,i,s),o.strokeStyle=t.color,o.fillStyle=l,o.lineWidth=2,o.beginPath(),o.moveTo(.5*i,.2*s),o.lineTo(.75*i,.6*s),o.arc(.5*i,.6*s,.25*i,0,Math.PI),o.lineTo(.5*i,.2*s),o.stroke(),o.fill()}return(0,s.YP)(t,c),(0,s.bv)(a),(0,s.Jd)(r),(e,t)=>((0,s.wg)(),(0,s.iD)("div",et,[(0,s._)("canvas",{class:"canvas",ref_key:"canvasRef",ref:n},null,512)]))}});const nt=tt;var it=nt;const st={class:"c-genome-pigments-editor"},lt={class:"pigments-view"},ot=(0,s._)("svg",{class:"pigments-view-arrow-icon",viewBox:"0 0 100 100"},[(0,s._)("path",{fill:"grey",d:"M 0 30 h 50 v -30 l 50 50 l -50 50 v -30 h -50"})],-1);var at=(0,s.aZ)({__name:"GenomePigmentsEditor",setup(e){const t=(0,s.f3)("selectedGenomeEntry"),n=(0,s.Fl)((()=>t.value?t.value.genome:M.newNullGenome())),i=(0,l.iH)();let o,d;function c(){const e=i.value,t=window.devicePixelRatio,{width:n,height:s}=e.getBoundingClientRect();e.width=Math.round(n*t),e.height=Math.round(s*t),h()}function h(){const e=d,t=r(a(n.value));e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle=u(t),e.strokeStyle=`rgb(${255*t[0]}, ${255*t[1]}, ${255*t[2]})`,e.lineWidth=.06*Math.min(e.canvas.width,e.canvas.height),e.beginPath(),e.arc(e.canvas.width/2,e.canvas.height/2,.45*Math.min(e.canvas.width,e.canvas.height),0,2*Math.PI),e.stroke(),e.fill()}return(0,s.bv)((()=>{o=new ResizeObserver(c),o.observe(i.value),d=i.value.getContext("2d")})),(0,s.Jd)((()=>{o.disconnect()})),(0,s.YP)(n,h,{deep:!0}),(e,o)=>((0,s.wg)(),(0,s.iD)("div",st,[(0,s._)("div",lt,[(0,s.Wm)(it,{class:"pigment-icon",color:"cyan",value:(0,l.SU)(n).cyanPigment},null,8,["value"]),(0,s.Wm)(it,{class:"pigment-icon",color:"magenta",value:(0,l.SU)(n).magentaPigment},null,8,["value"]),(0,s.Wm)(it,{class:"pigment-icon",color:"yellow",value:(0,l.SU)(n).yellowPigment},null,8,["value"]),(0,s.Wm)(it,{class:"pigment-icon",color:"white",value:(0,l.SU)(n).whitePigment},null,8,["value"]),ot,(0,s._)("canvas",{class:"final-color-canvas",ref_key:"finalColorCanvasRef",ref:i},null,512)]),(0,s.Wm)(Ie,{class:"label"},{default:(0,s.w5)((()=>[(0,s.Uk)("Cyan")])),_:1}),(0,s.Wm)(Ce,{class:"input",min:0,max:1,step:.01,disabled:!(0,l.SU)(t),modelValue:(0,l.SU)(n).cyanPigment,"onUpdate:modelValue":o[0]||(o[0]=e=>(0,l.SU)(n).cyanPigment=e)},null,8,["step","disabled","modelValue"]),(0,s.Wm)(Ie,{class:"label"},{default:(0,s.w5)((()=>[(0,s.Uk)("Magenta")])),_:1}),(0,s.Wm)(Ce,{class:"input",min:0,max:1,step:.01,disabled:!(0,l.SU)(t),modelValue:(0,l.SU)(n).magentaPigment,"onUpdate:modelValue":o[1]||(o[1]=e=>(0,l.SU)(n).magentaPigment=e)},null,8,["step","disabled","modelValue"]),(0,s.Wm)(Ie,{class:"label"},{default:(0,s.w5)((()=>[(0,s.Uk)("Yellow")])),_:1}),(0,s.Wm)(Ce,{class:"input",min:0,max:1,step:.01,disabled:!(0,l.SU)(t),modelValue:(0,l.SU)(n).yellowPigment,"onUpdate:modelValue":o[2]||(o[2]=e=>(0,l.SU)(n).yellowPigment=e)},null,8,["step","disabled","modelValue"]),(0,s.Wm)(Ie,{class:"label"},{default:(0,s.w5)((()=>[(0,s.Uk)("White")])),_:1}),(0,s.Wm)(Ce,{class:"input",min:0,max:1,step:.01,disabled:!(0,l.SU)(t),modelValue:(0,l.SU)(n).whitePigment,"onUpdate:modelValue":o[3]||(o[3]=e=>(0,l.SU)(n).whitePigment=e)},null,8,["step","disabled","modelValue"])]))}});const rt=at;var dt=rt;const ct={class:"c-cell-split-preview"};var ut=(0,s.aZ)({__name:"CellSplitPreview",props:{genome:{default:null}},setup(e){return(e,t)=>((0,s.wg)(),(0,s.iD)("div",ct))}});const ht=ut;var mt=ht;const pt=["disabled"];var gt=(0,s.aZ)({__name:"Checkbox",props:{modelValue:{type:Boolean},disabled:{type:Boolean}},emits:["update:modelValue"],setup(e,{emit:t}){const n=e,o=(0,l.iH)();return(0,s.YP)(o,(()=>t("update:modelValue",o.value))),(0,s.YP)(n,(()=>o.value=n.modelValue||!1)),(t,n)=>((0,s.wg)(),(0,s.iD)("label",{class:(0,Y.C_)(["c-checkbox",{disabled:e.disabled}])},[(0,s.wy)((0,s._)("input",{type:"checkbox",class:(0,Y.C_)(["input",{checked:o.value}]),disabled:e.disabled,"onUpdate:modelValue":n[0]||(n[0]=e=>o.value=e)},null,10,pt),[[i.e8,o.value]]),(0,s.WI)(t.$slots,"default")],2))}});const wt=gt;var ft=wt;const vt={class:"c-genome-children-editor"},yt={class:"inputs"};var bt=(0,s.aZ)({__name:"GenomeChildrenEditor",setup(e){const t=(0,s.f3)("genomeLibrary"),n=(0,s.f3)("selectedGenomeEntry"),i=(0,s.Fl)((()=>n.value?n.value.genome:M.newNullGenome())),o=(0,l.iH)(),a=(0,l.iH)();return(0,s.YP)(i,(()=>{o.value=t.value.lookupByGenome(i.value.children[0]),a.value=t.value.lookupByGenome(i.value.children[1])})),(0,s.YP)(o,(()=>{i.value.children[0]=o.value?.genome||i.value})),(0,s.YP)(a,(()=>{i.value.children[1]=a.value?.genome||i.value})),(e,r)=>((0,s.wg)(),(0,s.iD)("div",vt,[(0,s.Wm)(mt,{class:"preview",genome:(0,l.SU)(i)},null,8,["genome"]),(0,s._)("div",yt,[(0,s.Wm)(Ie,{class:"label"},{default:(0,s.w5)((()=>[(0,s.Uk)("Split mass")])),_:1}),(0,s.Wm)(Ce,{min:0,max:500,step:1,disabled:!(0,l.SU)(n),modelValue:(0,l.SU)(i).splitMass,"onUpdate:modelValue":r[0]||(r[0]=e=>(0,l.SU)(i).splitMass=e)},null,8,["disabled","modelValue"]),(0,s.Wm)(Ie,{class:"label"},{default:(0,s.w5)((()=>[(0,s.Uk)("Split angle")])),_:1}),(0,s.Wm)(Ce,{min:0,max:360,step:1,disabled:!(0,l.SU)(n),modelValue:(0,l.SU)(i).splitAngle,"onUpdate:modelValue":r[1]||(r[1]=e=>(0,l.SU)(i).splitAngle=e)},null,8,["disabled","modelValue"]),(0,s.Wm)(ft,{class:"input checkbox",disabled:!(0,l.SU)(n),modelValue:(0,l.SU)(i).stickOnSplit,"onUpdate:modelValue":r[2]||(r[2]=e=>(0,l.SU)(i).stickOnSplit=e)},{default:(0,s.w5)((()=>[(0,s.Uk)(" Stick children together ")])),_:1},8,["disabled","modelValue"]),(0,s.Wm)(Ie,{class:"label"},{default:(0,s.w5)((()=>[(0,s.Uk)("Child A angle")])),_:1}),(0,s.Wm)(Ce,{min:0,max:360,step:1,disabled:!(0,l.SU)(n),modelValue:(0,l.SU)(i).child1Angle,"onUpdate:modelValue":r[3]||(r[3]=e=>(0,l.SU)(i).child1Angle=e)},null,8,["disabled","modelValue"]),(0,s.Wm)(Ie,{class:"label"},{default:(0,s.w5)((()=>[(0,s.Uk)("Child B angle")])),_:1}),(0,s.Wm)(Ce,{min:0,max:360,step:1,disabled:!(0,l.SU)(n),modelValue:(0,l.SU)(i).child2Angle,"onUpdate:modelValue":r[4]||(r[4]=e=>(0,l.SU)(i).child2Angle=e)},null,8,["disabled","modelValue"]),(0,s.Wm)(Ie,{class:"label"},{default:(0,s.w5)((()=>[(0,s.Uk)("Child B genome")])),_:1}),(0,s.Wm)(Ke,{library:(0,l.SU)(t),disabled:!(0,l.SU)(n),modelValue:o.value,"onUpdate:modelValue":r[5]||(r[5]=e=>o.value=e)},null,8,["library","disabled","modelValue"]),(0,s.Wm)(Ie,{class:"label"},{default:(0,s.w5)((()=>[(0,s.Uk)("Child A genome")])),_:1}),(0,s.Wm)(Ke,{library:(0,l.SU)(t),disabled:!(0,l.SU)(n),modelValue:a.value,"onUpdate:modelValue":r[6]||(r[6]=e=>a.value=e)},null,8,["library","disabled","modelValue"]),(0,s.Wm)(ft,{class:"input checkbox",disabled:!(0,l.SU)(n),modelValue:(0,l.SU)(i).child1KeepConnections,"onUpdate:modelValue":r[7]||(r[7]=e=>(0,l.SU)(i).child1KeepConnections=e)},{default:(0,s.w5)((()=>[(0,s.Uk)(" Child A inherits connections ")])),_:1},8,["disabled","modelValue"]),(0,s.Wm)(ft,{class:"input checkbox",disabled:!(0,l.SU)(n),modelValue:(0,l.SU)(i).child2KeepConnections,"onUpdate:modelValue":r[8]||(r[8]=e=>(0,l.SU)(i).child2KeepConnections=e)},{default:(0,s.w5)((()=>[(0,s.Uk)(" Child B inherits connections ")])),_:1},8,["disabled","modelValue"])])]))}});const St=bt;var xt=St,Ct=(0,s.aZ)({__name:"GenomeEditor",setup(e){return(e,t)=>((0,s.wg)(),(0,s.iD)("div",null,[(0,s.Wm)(Qe,null,{default:(0,s.w5)((()=>[(0,s.Uk)("Pigments")])),_:1}),(0,s.Wm)(dt),(0,s.Wm)(Qe,null,{default:(0,s.w5)((()=>[(0,s.Uk)("Children")])),_:1}),(0,s.Wm)(xt)]))}});const _t=Ct;var Mt=_t,Pt=(0,s.aZ)({__name:"GenomeLibraryEditor",setup(e){const t=(0,s.f3)("genomeLibrary");let n=(0,l.iH)(null);return(0,s.JJ)("selectedGenomeEntry",n),(e,i)=>((0,s.wg)(),(0,s.j4)(he,{title:"Genome editor"},{default:(0,s.w5)((()=>[(0,s.Wm)(Ke,{library:(0,l.SU)(t),modelValue:(0,l.SU)(n),"onUpdate:modelValue":i[0]||(i[0]=e=>(0,l.dq)(n)?n.value=e:n=e)},null,8,["library","modelValue"]),(0,s.Wm)(Mt)])),_:1}))}});const Ut=Pt;var It=Ut,Zt=n.p+"img/pause.0ca6fd85.svg",kt=n.p+"img/play.83a91c31.svg";const Tt={class:"c-time-control"},At={key:0,class:"icon",src:Zt,alt:"pause icon"},Et={key:1,class:"icon",src:kt,alt:"play icon"};var Wt=(0,s.aZ)({__name:"TimeControl",setup(e){const t=(0,s.f3)("worldUpdater");function n(){t.simulationActive?t.pauseSimulation():t.startSimulation()}function i(e){t.simulationSpeed=e,t.startSimulation()}return(e,o)=>((0,s.wg)(),(0,s.iD)("div",Tt,[(0,s.Wm)(z,{class:"button pause-play-button",onClick:n},{default:(0,s.w5)((()=>[(0,l.SU)(t).simulationActive?((0,s.wg)(),(0,s.iD)("img",At)):((0,s.wg)(),(0,s.iD)("img",Et))])),_:1}),(0,s.Wm)(z,{class:"button play-1x-button","border-radius":"default 0 0 default","border-width":"default 0.5px default default",active:1===(0,l.SU)(t).simulationSpeed,onClick:o[0]||(o[0]=()=>i(1))},{default:(0,s.w5)((()=>[(0,s.Uk)(" x1 ")])),_:1},8,["active"]),(0,s.Wm)(z,{class:"button play-2x-button","border-radius":"0","border-width":"default 0.5px",active:2===(0,l.SU)(t).simulationSpeed,onClick:o[1]||(o[1]=()=>i(2))},{default:(0,s.w5)((()=>[(0,s.Uk)(" x2 ")])),_:1},8,["active"]),(0,s.Wm)(z,{class:"button play-5x-button","border-radius":"0.5px default default 0","border-width":"default default default 0.5px",active:5===(0,l.SU)(t).simulationSpeed,onClick:o[2]||(o[2]=()=>i(5))},{default:(0,s.w5)((()=>[(0,s.Uk)(" x5 ")])),_:1},8,["active"])]))}});const Vt=Wt;var Lt=Vt;class Dt{constructor(){(0,o.Z)(this,"name","Add cell"),(0,o.Z)(this,"icon",n(1038)),(0,o.Z)(this,"enabled",!0),(0,o.Z)(this,"selectedGenomeEntry",null)}init(e){e.addWorldEventListener(this,"world-click",this.onClick)}onSelect(){}onUnselect(){}onClick(e){if(!this.selectedGenomeEntry||e.worldX<0||e.worldY<0||e.worldX>=e.world.width||e.worldY>=e.world.height)return;const t=new y(new f(e.worldX,e.worldY),new f,400,0,0,this.selectedGenomeEntry.genome.deepCopy());e.world.add(t)}}var Nt=(0,s.aZ)({__name:"AddCellToolProperties",setup(e){const t=(0,s.f3)("genomeLibrary"),n=(0,s.f3)("toolsManager"),i=(0,l.iH)();return(0,s.YP)(i,(()=>{if(n.value.getSelectedTool()instanceof Dt){const e=n.value.getSelectedTool();e.selectedGenomeEntry=i.value}})),(e,n)=>((0,s.wg)(),(0,s.j4)(he,{title:"Add cell"},{default:(0,s.w5)((()=>[(0,s.Wm)(Ie,null,{default:(0,s.w5)((()=>[(0,s.Uk)("Genome of the new cell")])),_:1}),(0,s.Wm)(Ke,{library:(0,l.SU)(t),modelValue:(0,l.SU)(i),"onUpdate:modelValue":n[0]||(n[0]=e=>(0,l.dq)(i)?i.value=e:null)},null,8,["library","modelValue"])])),_:1}))}});const Ot=Nt;var Rt=Ot;const Ft={class:"c-controls-panel"},Yt=["src"],Gt={key:1,class:"buttons-separator"},Bt=(0,s._)("img",{class:"properties-tab__icon",src:R,alt:"Tab icon"},null,-1),Ht=(0,s._)("img",{class:"properties-tab__icon",src:F,alt:"Tab icon"},null,-1),jt={class:"tool-buttons-container"},Kt=["src"];var Xt=(0,s.aZ)({__name:"HudPanel",setup(e){const t=(0,s.f3)("toolsManager");return(e,n)=>((0,s.wg)(),(0,s.iD)("div",Ft,[(0,s.Wm)(X,{class:"properties-container"},{tabs:(0,s.w5)((()=>[(0,l.SU)(t).getSelectedTool()instanceof(0,l.SU)(Dt)?((0,s.wg)(),(0,s.j4)(te,{key:0,class:"properties-tab",name:"current-tool"},{default:(0,s.w5)((()=>[(0,s._)("img",{class:"properties-tab__icon",src:(0,l.SU)(t).getSelectedTool().icon,alt:"Tab icon"},null,8,Yt)])),_:1})):(0,s.kq)("",!0),(0,l.SU)(t).getSelectedTool()instanceof(0,l.SU)(Dt)?((0,s.wg)(),(0,s.iD)("div",Gt)):(0,s.kq)("",!0),(0,s.Wm)(te,{class:"properties-tab",name:"genome-editor"},{default:(0,s.w5)((()=>[Bt])),_:1}),(0,s.Wm)(te,{class:"properties-tab",name:"settings"},{default:(0,s.w5)((()=>[Ht])),_:1})])),bodies:(0,s.w5)((()=>[(0,s.Wm)(le,{name:"genome-editor"},{default:(0,s.w5)((()=>[(0,s.Wm)(It)])),_:1}),(0,s.Wm)(le,{name:"settings"},{default:(0,s.w5)((()=>[(0,s.Wm)(Te)])),_:1}),(0,l.SU)(t).getSelectedTool()instanceof(0,l.SU)(Dt)?((0,s.wg)(),(0,s.j4)(le,{key:0,name:"current-tool"},{default:(0,s.w5)((()=>[(0,s.Wm)(Rt)])),_:1})):(0,s.kq)("",!0)])),_:1}),(0,s._)("div",jt,[((0,s.wg)(!0),(0,s.iD)(s.HY,null,(0,s.Ko)((0,l.SU)(t).tools,(e=>((0,s.wg)(),(0,s.j4)(z,{class:"tool-button",key:e.name,disabled:!e.enabled,active:(0,l.SU)(t).getSelectedTool()===e,onClick:n=>(0,l.SU)(t).selectTool(e)},{default:(0,s.w5)((()=>[(0,s._)("img",{class:"tool-button__icon",src:e.icon,alt:"Tool icon"},null,8,Kt)])),_:2},1032,["disabled","active","onClick"])))),128))]),(0,s.Wm)(Lt)]))}});const qt=Xt;var $t=qt;class Jt{constructor(){(0,o.Z)(this,"entries",new Set)}search(e){const t=new Set;return this.entries.forEach((n=>{n.name.toLowerCase().includes(e.toLowerCase())&&t.add(n)})),t}lookupByGenome(e){for(const t of this.entries)if(t.genome==e)return t;return null}}class zt{constructor(e,t){(0,o.Z)(this,"name",void 0),(0,o.Z)(this,"genome",void 0),this.name=e,this.genome=t}}class Qt{}class en{constructor(e,t){(0,o.Z)(this,"tools",void 0),(0,o.Z)(this,"world",void 0),(0,o.Z)(this,"currentTool",void 0),(0,o.Z)(this,"eventListeners",new Map),this.tools=e,this.world=t,e.forEach((e=>e.init(this,t))),this.currentTool=e[0]}getSelectedTool(){return this.currentTool}selectTool(e){e!=this.currentTool&&(this.currentTool.onUnselect(),this.currentTool=e,e.onSelect())}addWorldEventListener(e,t,n){const i={eventType:t,handler:n.bind(e)};this.eventListeners.has(e)||this.eventListeners.set(e,new Map);const s=this.eventListeners.get(e);s.set(t,i)}dispatchEvent(e){const t=this.eventListeners.get(this.currentTool);if(!t)return;const n=t.get(e.type);n&&n.handler(e)}}class tn{constructor(){(0,o.Z)(this,"name","Remove cell"),(0,o.Z)(this,"icon",n(4765)),(0,o.Z)(this,"enabled",!0)}init(e){e.addWorldEventListener(this,"world-click",this.onClick)}onSelect(){}onUnselect(){}onClick(e){const t=new f(e.worldX,e.worldY),n=e.world.pointCast(t,1);let i=null,s=0;n.filter((e=>e instanceof y)).forEach((e=>{const n=e,l=t.distance(n.center);(null==i||l<s)&&(i=n,s=l)})),i&&e.world.remove(i)}}class nn{constructor(){(0,o.Z)(this,"name","Selection"),(0,o.Z)(this,"icon",n(8611)),(0,o.Z)(this,"enabled",!0)}init(){}onSelect(){}onUnselect(){}}class sn{constructor(e,t){(0,o.Z)(this,"world",void 0),(0,o.Z)(this,"context",void 0),this.world=e,this.context=t}update(){}}class ln{}class on{constructor(e,t){(0,o.Z)(this,"world",void 0),(0,o.Z)(this,"context",void 0),(0,o.Z)(this,"cellsSpeedBuffer",new Map),(0,o.Z)(this,"cellsAngularSpeedBuffer",new Map),this.world=e,this.context=t}update(e){this.reset();for(const t of this.world.cells.values()){this.processGravity(t,e),this.world.pointCast(t.center,t.radius).forEach((n=>{n instanceof S?this.processCellWallCollision(t,n,e):n instanceof y&&this.processCellsCollision(t,n,e)}));for(const n of t.connections.values())this.processCellConnection(t,n,e)}this.apply()}reset(){this.cellsSpeedBuffer.clear(),this.cellsAngularSpeedBuffer.clear();for(const e of this.world.cells.values())this.cellsSpeedBuffer.set(e.id,e.speed),this.cellsAngularSpeedBuffer.set(e.id,e.angularSpeed)}apply(){this.cellsSpeedBuffer.forEach(((e,t)=>{const n=this.world.cells.get(t);n&&(n.speed=e)})),this.cellsAngularSpeedBuffer.forEach(((e,t)=>{const n=this.world.cells.get(t);n&&(n.angularSpeed=e)}))}processGravity(e,t){let n=this.cellsSpeedBuffer.get(e.id);n=n.plus(this.world.gravity.times(t)),this.cellsSpeedBuffer.set(e.id,n)}processCellWallCollision(e,t,n){const i=U.findLineAndCircleIntersections(e.center,e.radius,t.a,t.b);if(0!==i.length){const i=U.projectPointOntoLine(e.center,[t.a,t.b]),s=i.to(e.center).unit.times(e.radius-i.distance(e.center)),l=U.clamp(1-e.center.distance(i)/e.radius,0,1),o=U.clamp(2*(1-e.genome.hardness)*(l-.5)+1,0,1),a=this.cellsSpeedBuffer.get(e.id);let r=a.plus(s.times(o*n));if(l>.5){const t=e.center.to(i).angle-e.speed.angle,n=Math.abs(t)<Math.PI/4?Math.cos(t):0;r=r.plus(i.to(e.center).unit.times(2*e.speed.length*n))}this.cellsSpeedBuffer.set(e.id,r)}}processCellsCollision(e,t,n){if(e.id==t.id)return;const i=e.center.to(t.center),s=i.length,l=e.radius+t.radius;if(s<=e.radius+t.radius){const o=i.unit,a=i.minus(o.times(t.radius)),r=o.times(e.radius),d=a.minus(r),c=(l-s)/l*2,u=(e.genome.hardness+t.genome.hardness)/2,h=U.clamp(2*(1-u)*(c-.5)+1,0,1),m=d.times(h*t.mass/(e.mass+t.mass)),p=this.cellsSpeedBuffer.get(e.id),g=p.plus(m.times(n));this.cellsSpeedBuffer.set(e.id,g)}}processCellConnection(e,t,n){const i=this.world.cells.get(t.partnerId);if(!i)return;const s=i.connections.get(e.id);if(s)for(let l=0;l<4;l++){const o=l*Math.PI/24-1.5*Math.PI/24,a=e.angle+t.angle+o,r=e.center.plus(f.unit(a).times(e.radius)).minus(f.unit(a).times(on.CELL_STICKINESS_DEPTH)),d=i.center.plus(f.unit(i.angle+s.angle-o).times(i.radius)).minus(f.unit(i.angle+s.angle-o).times(on.CELL_STICKINESS_DEPTH)),c=r.to(d).div(4).times(n);this.applyImpulse(e,r,c)}}applyImpulse(e,t,n){if(0==n.length)return;const i=t.to(e.center).angle,s=i-n.angle,l=e.center.distance(t),o=Math.sin(s)*l,a=1/((o/e.radius)**2+1),r=1-a,d=this.cellsSpeedBuffer.get(e.id),c=d.plus(n.times(a)),u=this.cellsAngularSpeedBuffer.get(e.id),h=u-Math.atan(n.length/o)*r;this.cellsSpeedBuffer.set(e.id,c),this.cellsAngularSpeedBuffer.set(e.id,h)}}(0,o.Z)(on,"CELL_STICKINESS_DEPTH",3);class an{constructor(e){(0,o.Z)(this,"world",void 0),this.world=e}update(e){this.world.cells.forEach((t=>{t.center=t.center.plus(t.speed.times(e)),t.angle+=t.angularSpeed*e,t.speed=t.speed.minus(t.speed.times(this.world.viscosity*e)),t.angularSpeed-=t.angularSpeed*this.world.viscosity*e})),this.world.updateCollisionSystem()}}class rn{constructor(e){(0,o.Z)(this,"world",void 0),(0,o.Z)(this,"debt",0),this.world=e}update(e){this.updateFoodSpawning(e),this.updateFoodLifecycle(e)}updateFoodSpawning(e){const t=this.world.foodSpawnRate*this.world.width*this.world.height/1e6;this.debt+=t*e;const n=Math.floor(this.debt);for(let i=0;i<n;i++)this.spawnFoodAtRandomPlace();this.debt-=n}updateFoodLifecycle(e){this.world.food.forEach((t=>{t.mass-=this.world.foodMassLoss*e,t.mass<this.world.minFoodMass&&this.world.remove(t)}))}spawnFoodAtRandomPlace(){const e=new f(Math.random()*this.world.width,Math.random()*this.world.height),t=40+40*Math.random(),n=new v(e,t);this.world.add(n)}}class dn{constructor(e){(0,o.Z)(this,"world",void 0),this.world=e}update(e){const t={};this.updateNutritionExchanges(t,e),this.world.cells.forEach((n=>this.updateCellNutrition(n,t,e))),this.world.cells.forEach((e=>e.mass=t[e.id]||e.mass)),this.killStarvingCells()}updateCellNutrition(e,t,n){const i=this.world.maxNutritionGainSpeed*n,s=this.calculateLiveCost(e)*n;if(t[e.id]=(t[e.id]||e.mass)-s,e.genome.type==_.PHAGOCYTE){let n=Math.min(this.world.maxCellMass-t[e.id],i-(e.mass-t[e.id]));this.world.pointCast(e.center,e.radius).forEach((i=>{if(i instanceof v){const s=i,l=U.clamp(s.mass,0,n);t[e.id]+=l,s.mass-=l,n-=l}}))}}updateNutritionExchanges(e,t){const n=this.world.maxNutritionGainSpeed*t;this.world.cells.forEach((t=>{0!=t.connections.size&&t.connections.forEach(((i,s)=>{if(s<=t.id)return;const l=this.world.cells.get(s),o=t.mass/l.mass,a=t.genome.nutritionPriority+l.genome.nutritionPriority!=0?t.genome.nutritionPriority/l.genome.nutritionPriority:1,r=Math.min(this.world.maxCellMass-e[t.id],n-(t.mass-e[t.id])),d=Math.min(this.world.maxCellMass-l.mass,n-(l.mass-e[l.id])),c=isFinite(a)?(a-o)/(a+o):Number.POSITIVE_INFINITY,u=U.clamp(U.clamp(c*n,-t.mass,l.mass),-d,r);e[t.id]=(e[t.id]||t.mass)+u,e[l.id]=(e[l.id]||l.mass)-u}))}))}killStarvingCells(){this.world.cells.forEach((e=>{e.mass<this.world.minCellMass&&(this.world.remove(e),this.world.add(new v(e.center,Math.sqrt(e.mass))))}))}calculateLiveCost(e){return.0075*e.mass}}class cn{constructor(e){(0,o.Z)(this,"world",void 0),this.world=e}update(e){this.world.cells.forEach((t=>{if(t.age+=e,this.doTypeSpecificThings(t,e),t.mass>t.genome.splitMass&&this.split(t),t.center.isNaN())throw Error("Cell id = "+t.id+" has NaN position!")}))}doTypeSpecificThings(e,t){if(e.genome.type==_.FLAGELLOCYTE){const n=f.unit(e.angle).times(e.genome.flagellumForce),i=n.minus(e.speed),s=f.unit(e.angle).times(f.unit(e.angle).dot(i)).times(t);e.applyImpulse(e.center,s),e.mass-=i.length*this.world.flagellocyteFlagellumForceCost*t,e.connections.forEach((t=>{Math.abs(t.angle-Math.PI)<Math.PI/12&&(this.world.remove(e),this.world.add(new v(e.center,Math.sqrt(e.mass))))}))}}split(e){const t=e.angle+e.genome.splitAngle+Math.PI/2,n=e.center.plus(f.unit(t-Math.PI/2)),i=e.center.plus(f.unit(t+Math.PI/2)),s=e.angle+e.genome.splitAngle+e.genome.child1Angle,l=e.angle+e.genome.splitAngle+e.genome.child2Angle,o=e.genome.children[0].deepCopy(),a=e.genome.children[1].deepCopy();o.applyRadiation(this.world,this.world.radiation),a.applyRadiation(this.world,this.world.radiation);const r=(-e.genome.child1Angle+3*Math.PI)%(2*Math.PI),d=(-e.genome.child2Angle+2*Math.PI)%(2*Math.PI),c=new y(n,e.speed,e.mass/2,s,0,o),u=new y(i,e.speed,e.mass/2,l,0,a);this.world.add(c),this.world.add(u),e.genome.stickOnSplit&&(c.connections.set(u.id,new b(r,u.id)),u.connections.set(c.id,new b(d,c.id)));const h=this;function m(t){e.connections.forEach((n=>{const i=t.id==c.id,s=h.world.cells.get(n.partnerId),l=s.connections.get(e.id);let o=e.genome.splitAngle-n.angle+Math.PI/2;i||(o+=Math.PI),o%=2*Math.PI;const a=o>=Math.PI/15&&o<=Math.PI-Math.PI/15,r=o>=-Math.PI/15&&o<=Math.PI+Math.PI/15,d=e.genome.child1KeepConnections&&e.genome.child2KeepConnections,u=i?e.genome.child1Angle:e.genome.child2Angle;if(a||r&&!d)s.connections.set(t.id,new b(l.angle,t.id)),t.connections.set(s.id,new b((n.angle-e.genome.splitAngle-u+2*Math.PI)%(2*Math.PI),s.id));else if(r){let o=Math.PI/6;i||(o*=-1),Math.abs(e.genome.splitAngle-n.angle+Math.PI/2)>Math.PI/15&&(o*=-1),s.connections.set(t.id,new b(l.angle+o,t.id)),t.connections.set(s.id,new b((n.angle-e.genome.splitAngle-u+o+2*Math.PI)%(2*Math.PI),s.id))}}))}e.genome.child1KeepConnections&&m(c),e.genome.child2KeepConnections&&m(u),this.world.remove(e)}}class un{constructor(e){(0,o.Z)(this,"world",void 0),(0,o.Z)(this,"updateContext",void 0),(0,o.Z)(this,"updatePipeline",void 0),(0,o.Z)(this,"simulationSpeed",1),(0,o.Z)(this,"intervalId",-1),(0,o.Z)(this,"lastUpdateMillis",-1),this.world=e,this.updateContext=new ln,this.updatePipeline=[new sn(this.world,this.updateContext),new on(this.world,this.updateContext),new rn(this.world),new dn(this.world),new cn(this.world),new an(this.world)]}get simulationActive(){return-1!=this.intervalId}startSimulation(){this.simulationActive||(this.intervalId=setInterval(this.intervalRoutine.bind(this),un.SIMULATION_TICK_FIXED_DELTA),this.lastUpdateMillis=Date.now())}pauseSimulation(){this.simulationActive&&clearInterval(this.intervalId),this.intervalId=-1}tick(e){for(const t of this.updatePipeline)t.update(e)}intervalRoutine(){const e=Date.now()-this.lastUpdateMillis,t=Math.round(e/un.SIMULATION_TICK_FIXED_DELTA),n=Math.min(Math.round(e*this.simulationSpeed/un.SIMULATION_TICK_FIXED_DELTA),10);for(let i=0;i<n;i++)this.tick(un.SIMULATION_TICK_FIXED_DELTA/1e3*un.SIMULATION_SPEED_FACTOR);this.lastUpdateMillis+=un.SIMULATION_TICK_FIXED_DELTA*t}}(0,o.Z)(un,"SIMULATION_TICK_FIXED_DELTA",16),(0,o.Z)(un,"SIMULATION_SPEED_FACTOR",5);var hn=(0,s.aZ)({__name:"App",setup(e){const t=[new nn,new Dt,new tn],n=T.TEMPORARY_DEBUG,i=new Jt,o=new un(n),a=new Qt,r=new en(t,n);function d(e){e instanceof V&&r.dispatchEvent(e)}return i.entries.add(new zt("my genome",M.newSampleGenome())),i.entries.add(new zt("test",M.newSampleGenome())),i.entries.add(new zt("aaaaaaaaa",M.newSampleGenome())),i.entries.add(new zt("aboba",M.newSampleGenome())),(0,s.JJ)("world",n),(0,s.JJ)("worldUpdater",(0,l.Um)(o)),(0,s.JJ)("genomeLibrary",(0,l.iH)(i)),(0,s.JJ)("appPreferences",(0,l.iH)(a)),(0,s.JJ)("toolsManager",(0,l.iH)(r)),(e,t)=>((0,s.wg)(),(0,s.iD)(s.HY,null,[(0,s.Wm)(O,{onWorldClick:d}),(0,s.Wm)($t,{class:"controls-panel"})],64))}});const mn=hn;var pn=mn;const gn=(0,i.ri)(pn);gn.directive("click-outside",{mounted:function(e,t){e.clickOutsideEvent=function(n){e==n.target||e.contains(n.target)||t.value(n)},document.body.addEventListener("click",e.clickOutsideEvent)},beforeUnmount:function(e){document.body.removeEventListener("click",e.clickOutsideEvent)}}),gn.mount("#app")},1038:function(e,t,n){e.exports=n.p+"img/add-cell.8921f3c5.svg"},4765:function(e,t,n){e.exports=n.p+"img/remove-cell.5376df6e.svg"},8611:function(e,t,n){e.exports=n.p+"img/selection.a43fadcc.svg"}},t={};function n(i){var s=t[i];if(void 0!==s)return s.exports;var l=t[i]={exports:{}};return e[i](l,l.exports,n),l.exports}n.m=e,function(){var e=[];n.O=function(t,i,s,l){if(!i){var o=1/0;for(c=0;c<e.length;c++){i=e[c][0],s=e[c][1],l=e[c][2];for(var a=!0,r=0;r<i.length;r++)(!1&l||o>=l)&&Object.keys(n.O).every((function(e){return n.O[e](i[r])}))?i.splice(r--,1):(a=!1,l<o&&(o=l));if(a){e.splice(c--,1);var d=s();void 0!==d&&(t=d)}}return t}l=l||0;for(var c=e.length;c>0&&e[c-1][2]>l;c--)e[c]=e[c-1];e[c]=[i,s,l]}}(),function(){n.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return n.d(t,{a:t}),t}}(),function(){n.d=function(e,t){for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})}}(),function(){n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){n.p=""}(),function(){var e={143:0};n.O.j=function(t){return 0===e[t]};var t=function(t,i){var s,l,o=i[0],a=i[1],r=i[2],d=0;if(o.some((function(t){return 0!==e[t]}))){for(s in a)n.o(a,s)&&(n.m[s]=a[s]);if(r)var c=r(n)}for(t&&t(i);d<o.length;d++)l=o[d],n.o(e,l)&&e[l]&&e[l][0](),e[l]=0;return n.O(c)},i=self["webpackChunkcybercells"]=self["webpackChunkcybercells"]||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))}();var i=n.O(void 0,[998],(function(){return n(969)}));i=n.O(i)})();
//# sourceMappingURL=app.f043f8c7.js.map