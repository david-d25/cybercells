(function(){"use strict";var e={7439:function(e,t,n){var i=n(9197),s=n(8473),a=n(4188),r=n(5252);n(7658);class o{constructor(e){(0,r.Z)(this,"gl",void 0),this.gl=e}static init(e){const t=e.getContext("webgl2",{powerPreference:"high-performance"});if(null==t)throw new Error("Unable to initialize WebGL!");return new o(t)}newShader(e,t){const n=this.loadShader(this.gl.VERTEX_SHADER,e),i=this.loadShader(this.gl.FRAGMENT_SHADER,t),s=this.gl.createProgram();if(this.gl.attachShader(s,n),this.gl.attachShader(s,i),this.gl.linkProgram(s),!this.gl.getProgramParameter(s,this.gl.LINK_STATUS))throw new Error(`Couldn't link shaders! Logs:\n${this.gl.getProgramInfoLog(s)}`);return s}newTexture(e,t){const n=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,n),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,e,t,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),n}newArrayBuffer(e){const t=this.gl.createBuffer();if(null==t)throw new Error("Could not create buffer");return this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(e),this.gl.STATIC_DRAW),t}destroy(){this.gl.getExtension("WEBGL_lose_context").loseContext()}loadShader(e,t){const n=this.gl.createShader(e);if(this.gl.shaderSource(n,t),this.gl.compileShader(n),!this.gl.getShaderParameter(n,this.gl.COMPILE_STATUS))throw new Error(`Couldn't compile shaders! Logs:\n\n${this.gl.getShaderInfoLog(n)}`);return n}}var l=n(3499),c=n(4364),d="#version 300 es\n\nin vec4 vertexPosition;\nin vec2 textureCoordinate;\nout vec2 texel;\n\nvoid main() {\n    gl_Position = vertexPosition;\n    texel = textureCoordinate;\n}",u="#version 300 es\n\nprecision highp float;\nprecision highp sampler2D;\n\nconst float CHECKER_SIZE = 25.0;\nconst vec4 LIGHT_COLOR = vec4(0.88, 0.88, 1, 1);\n\nuniform mat4 viewMatrix;\nuniform float time;\nuniform vec2 areaSize;\n\nuniform float lightIntensity;\n\nout vec4 color;\n\nvec4 lightFunction(float x, float y) {\n    return vec4(0, 0, 0, 0);\n}\n\nvoid main() {\n    vec4 fragment = viewMatrix * gl_FragCoord;\n    float x = fragment.x;\n    float y = fragment.y;\n\n    float value = mod(floor(x/CHECKER_SIZE) + floor(y/CHECKER_SIZE), 2.0) == 0.0 ? 0.4 : 0.2;\n    color = vec4(value, value, value, 1);\n//    color = vec4(0.4, 0.7, 0.9, 1);\n    color = mix(color, lightFunction(x, y), lightIntensity);\n\n    if (x < 0.0 || y < 0.0 || x >= areaSize.x || y >= areaSize.y)\n        color = mix(color, vec4(0, 0, 0, 1), 0.3);\n}",h="#version 300 es\n\nprecision highp float;\nprecision highp sampler2D;\n\nconst float POSITIVE_INFINITY = 1.0 / 0.0;\nconst float NAN = 0.0 / 0.0;\n\nconst float CELL_BORDER_WIDTH = 2.0;\nconst int MAX_OBSTACLES = 32;\n\nstruct Cell {\n    int id;\n    vec2 center;\n    vec2 speed;\n    float mass;\n    float angle;\n    float radius;\n    vec4 bodyRgba;\n};\n\nstruct Obstacle {\n    vec2 a;\n    vec2 b;\n};\n\nuniform sampler2D image;\nuniform vec2 imageSize;\nuniform mat4 viewMatrix;\nuniform float time;\n\nuniform Cell cell;\n\nuniform Obstacle obstacles[MAX_OBSTACLES];\nuniform int obstaclesSize;\n\nin vec2 texel;\nout vec4 color;\n\nvec4 previousLayerColor(float x, float y) {\n    vec2 imagePixelSize = vec2(1.0, 1.0) / imageSize;\n    return texture(image, vec2(texel.x + x * imagePixelSize.x, texel.y + y * imagePixelSize.y));\n}\n\nvec2 projectPointOntoLine(vec2 p, vec2 lineStart, vec2 lineEnd) {\n    vec2 a = lineStart;\n    vec2 b = lineEnd;\n    if (a == b)\n        return a;\n    return (b - a) * dot(p - a, b - a) / dot(b - a, b - a) + a;\n}\n\nvec2 findVerticalLineIntersection(vec2 verticalStart, vec2 verticalEnd, vec2 otherStart, vec2 otherEnd) {\n    if (otherStart.x == otherEnd.x)\n        return vec2(NAN);\n\n    float otherAngleRatio = (otherEnd.y - otherStart.y) / (otherEnd.x - otherStart.x);\n    float otherOffset = otherStart.y - otherAngleRatio * otherStart.x;\n    vec2 intersection = vec2(verticalStart.x, 0);\n    intersection.y = otherAngleRatio * intersection.x + otherOffset;\n    if (otherStart.x < intersection.x && otherEnd.x < intersection.x ||\n        otherStart.x > intersection.x && otherEnd.x > intersection.x)\n        return vec2(NAN);\n    float avgY = (verticalStart.y + verticalEnd.y)/2.0;\n    float height = abs(verticalStart.y - verticalEnd.y);\n    return abs(intersection.y - avgY) <= height/2.0 ? intersection : vec2(NAN);\n}\n\nvec2 findLinesIntersections(vec2 line1Start, vec2 line1End, vec2 line2Start, vec2 line2End) {\n    vec2 line1Vector = line1End - line1Start;\n    vec2 line2Vector = line2End - line2Start;\n\n    float angle1Ratio = line1Vector.y / line1Vector.x;\n    float angle2Ratio = line2Vector.y / line2Vector.x;\n\n    if (isnan(angle1Ratio) || isnan(angle2Ratio)\n        || isinf(angle1Ratio) && isinf(angle2Ratio)\n        || angle1Ratio == angle2Ratio)\n        return vec2(NAN);\n\n    if (isinf(angle1Ratio))\n        return findVerticalLineIntersection(line1Start, line1End, line2Start, line2End);\n    if (isinf(angle2Ratio))\n        return findVerticalLineIntersection(line2Start, line2End, line1Start, line1End);\n\n    float line1Offset = line1Start.y - angle1Ratio * line1Start.x;\n    float line2Offset = line2Start.y - angle2Ratio * line2Start.x;\n\n    vec2 intersection = vec2((line2Offset - line1Offset) / (angle1Ratio - angle2Ratio), 0);\n    intersection.y = angle1Ratio * intersection.x + line1Offset;\n\n    vec2 v1 = intersection - line1Start;\n    vec2 v2 = intersection - line2Start;\n    return (\n        dot(line1Vector, v1) >= 0.0 &&\n        dot(line1Vector, v1) <= dot(line1Vector, line1Vector) &&\n        dot(line2Vector, v2) >= 0.0 &&\n        dot(line2Vector, v2) <= dot(line2Vector, line2Vector)\n    ) ? intersection : vec2(NAN);\n}\n\nfloat nearestObstacleDistance(vec2 p) {\n    float result = POSITIVE_INFINITY;\n\n    for (int i = 0; i < obstaclesSize; i++) {\n        Obstacle obstacle = obstacles[i];\n        vec2 projected = projectPointOntoLine(p, obstacle.a, obstacle.b);\n        float fractionalDistance = length(projected - obstacle.a) / length(obstacle.b - obstacle.a) * sign(dot(obstacle.b - obstacle.a, projected - obstacle.a));\n        if (fractionalDistance >= 0.0 && fractionalDistance < 1.0 && length(projected - p) < result)\n            result = length(projected - p);\n    }\n\n    return result;\n}\n\nbool isPointBehindLine(vec2 p, vec2 lineStart, vec2 lineEnd) {\n    return !any(isnan(findLinesIntersections(cell.center, p, lineStart, lineEnd)));\n}\n\nbool isPointBehindObstacles(vec2 p) {\n    for (int i = 0; i < obstaclesSize; i++) {\n        Obstacle obstacle = obstacles[i];\n        if (isPointBehindLine(p, obstacle.a, obstacle.b))\n            return true;\n    }\n\n    return false;\n}\n\nvoid main() {\n    vec4 fragment = viewMatrix * gl_FragCoord;\n    float x = fragment.x;\n    float y = fragment.y;\n\n    vec2 imagePixelSize = vec2(1.0, 1.0) / imageSize;\n\n    vec4 background = texture(image, texel);\n    vec4 layerColor = vec4(0);\n\n    vec4 borderColor = mix(cell.bodyRgba, vec4(0, 0, 0, 1), 0.25);\n    float centerDistance = sqrt(pow(x - cell.center.x, 2.0) + pow(y - cell.center.y, 2.0));\n\n    // This may be optimized to round through the obstacles array once per fragment\n    if (centerDistance <= cell.radius && !isPointBehindObstacles(fragment.xy)) {\n        layerColor = cell.bodyRgba;\n\n        if (centerDistance > cell.radius - CELL_BORDER_WIDTH\n            || nearestObstacleDistance(fragment.xy) <= CELL_BORDER_WIDTH)\n            layerColor = borderColor;\n    }\n\n    color = mix(background, vec4(layerColor.rgb, 1), layerColor.a);\n}",m="#version 300 es\n\nprecision highp float;\nprecision highp sampler2D;\n\nconst float WALL_THICKNESS = 2.0;\n\nstruct Wall {\n    vec2 a;\n    vec2 b;\n};\n\nuniform sampler2D image;\nuniform vec2 imageSize;\nuniform mat4 viewMatrix;\nuniform Wall wall;\n\nin vec2 texel;\nout vec4 color;\n\nvec2 projectToWall(vec2 p) {\n    vec2 a = wall.a;\n    vec2 b = wall.b;\n    if (a == b)\n        return a;\n    return (b - a) * dot(p - a, b - a) / dot(b - a, b - a) + a;\n}\n\nvoid main() {\n    vec4 fragment = viewMatrix * gl_FragCoord;\n    float x = fragment.x;\n    float y = fragment.y;\n\n    vec4 background = texture(image, texel);\n    vec4 layerColor = vec4(0);\n\n    vec2 projected = projectToWall(fragment.xy);\n    float fractionalDistance = length(projected - wall.a) / length(wall.b - wall.a) * sign(dot(wall.b - wall.a, projected - wall.a));\n\n    if (length(fragment.xy - projected) < WALL_THICKNESS/2.0\n        && fractionalDistance >= 0.0 && fractionalDistance < 1.0\n        || length(wall.a - fragment.xy) < WALL_THICKNESS/2.0\n        || length(wall.b - fragment.xy) < WALL_THICKNESS/2.0)\n        layerColor = vec4(0, 0, 0, 1);\n\n    color = mix(background, vec4(layerColor.rgb, 1), layerColor.a);\n}",f="#version 300 es\n\nprecision highp float;\nprecision highp sampler2D;\n\nuniform sampler2D image;\n\nin vec2 texel;\nout vec4 color;\n\nvoid main() {\n    color = texture(image, texel);\n}";const{sqrt:g,pow:v,sin:p,cos:w,acos:x,PI:b}=Math;class y{constructor(e=0,t=0){(0,r.Z)(this,"x",void 0),(0,r.Z)(this,"y",void 0),this.x=e,this.y=t}get length(){return g(v(this.x,2)+v(this.y,2))}plus(e){return e instanceof y?new y(this.x+e.x,this.y+e.y):new y(this.x+e,this.y+e)}minus(e){return e instanceof y?new y(this.x-e.x,this.y-e.y):new y(this.x-e,this.y-e)}times(e){return e instanceof y?new y(this.x*e.y,this.y*e.y):new y(this.x*e,this.y*e)}div(e){return e instanceof y?new y(this.x/e.y,this.x/e.y):new y(this.x/e,this.y/e)}get negative(){return new y(-this.x,-this.y)}dot(e){return this.x*e.x+this.y*e.y}to(e){return e.minus(this)}nearest(...e){return e.reduce(((e,t)=>this.distance(e)>this.distance(t)?t:e))}shortestAngularTurn(e){const t=e.angle-this.angle;return t<-b||t>=0&&t<b?1:-1}positiveAngleDiff(e){return(this.angle-e.angle+2*b)%(2*b)}get angle(){return this.y>0?2*b-x(this.x/this.length):x(this.x/this.length)}get angleSafe(){return 0!=this.length?this.angle:0}distance(e){return g(v(this.x-e.x,2)+v(this.y-e.y,2))}isNaN(){return isNaN(this.x)||isNaN(this.y)}rotate(e){return new y(this.x*w(e)-this.y*p(e),this.x*p(e)+this.y*w(e))}get unit(){return 0!=this.length?new y(this.x/this.length,this.y/this.length):new y}static isNaN(e){return isNaN(e.x)||isNaN(e.y)}static unit(e){return new y(w(e),p(e))}static equals(e,t){return null==e&&null==t||null!=e&&null!=t&&(e.x==t.x&&e.y==t.y)}}class S{constructor(e,t){(0,r.Z)(this,"min",void 0),(0,r.Z)(this,"max",void 0),this.min=e,this.max=t}get center(){return new y((this.min.x+this.max.x)/2,(this.min.y+this.max.y)/2)}get width(){return this.max.x-this.min.x}get height(){return this.max.y-this.min.y}}class _{constructor(e,t,n,i,s,a){(0,r.Z)(this,"center",void 0),(0,r.Z)(this,"speed",void 0),(0,r.Z)(this,"mass",void 0),(0,r.Z)(this,"angle",void 0),(0,r.Z)(this,"angularSpeed",void 0),(0,r.Z)(this,"genome",void 0),(0,r.Z)(this,"id",-1),(0,r.Z)(this,"connections",new Map),(0,r.Z)(this,"age",0),this.center=e,this.speed=t,this.mass=n,this.angle=i,this.angularSpeed=s,this.genome=a}get radius(){return Math.sqrt(this.mass)}get aabb(){return new S(this.center.minus(this.radius),this.center.plus(this.radius))}}class T{constructor(e,t){(0,r.Z)(this,"a",void 0),(0,r.Z)(this,"b",void 0),(0,r.Z)(this,"id",-1),this.a=e,this.b=t}}class E{static findLineAndCircleIntersections(e,t,n,i){const s=i.minus(n),a=n.minus(e),r=-2*s.dot(a),o=2*(Math.pow(s.x,2)+Math.pow(s.y,2)),l=Math.sqrt(Math.pow(r,2)-2*o*(Math.pow(a.x,2)+Math.pow(a.y,2)-Math.pow(t,2)));if(isNaN(l))return[];const c=(r-l)/o,d=(r+l)/o,u=[];return c>=0&&c<=1&&u.push(new y(n.x+s.x*c,n.y+s.y*c)),d>=0&&d<=1&&u.push(new y(n.x+s.x*d,n.y+s.y*d)),u}static findCirclesIntersections(e,t,n,i){const s=e.distance(n);if(s>t+i)return[];const a=e.plus(n).times(.5).plus(n.minus(e).times(Math.pow(t,2)-Math.pow(i,2)).div(2*Math.pow(s,2))),r=new y(n.y-e.y,e.x-n.x).times(.5*Math.sqrt(2*(Math.pow(t,2)+Math.pow(i,2))/Math.pow(s,2)-Math.pow(Math.pow(t,2)-Math.pow(i,2),2)/Math.pow(s,4)-1));return a.isNaN()||r.isNaN()?[]:[a.plus(r),a.minus(r)]}static findLinesIntersection(e,t){const n=e[0].to(e[1]),i=t[0].to(t[1]),s=n.y/n.x,a=i.y/i.x;if(isNaN(s)||isNaN(a)||!isFinite(s)&&!isFinite(a)||s==a)return null;if(!isFinite(s))return E.findVerticalLineIntersection(e,t);if(!isFinite(a))return E.findVerticalLineIntersection(t,e);const r=e[0].y-s*e[0].x,o=t[0].y-a*t[0].x,l=new y((o-r)/(s-a),0);l.y=s*l.x+r;const c=e[0].to(l),d=t[0].to(l);return n.dot(c)>=0&&n.dot(c)<=n.dot(n)&&i.dot(d)>=0&&i.dot(d)<=i.dot(i)?l:null}static projectPointOntoLine(e,t){const n=t[0],i=t[1];return n.x==i.x?new y(n.x,e.y):n.to(i).times(n.to(e).dot(n.to(i))/n.to(i).dot(n.to(i))).plus(n)}static clamp(e,t,n){return Math.min(Math.max(e,t),n)}static findVerticalLineIntersection(e,t){if(t[0].x==t[1].x)return null;const n=(t[1].y-t[0].y)/(t[1].x-t[0].x),i=t[0].y-n*t[0].x,s=new y(e[0].x,0);if(s.y=n*s.x+i,t[0].x<s.x&&t[1].x<s.x||t[0].x>s.x&&t[1].x>s.x)return null;const a=(e[0].y+e[1].y)/2,r=Math.abs(e[0].y-e[1].y);return Math.abs(s.y-a)<=r/2?s:null}}class M{constructor(e,t,n,i,s,a=null){(0,r.Z)(this,"shaderManager",void 0),(0,r.Z)(this,"backgroundShader",void 0),(0,r.Z)(this,"cellShader",void 0),(0,r.Z)(this,"wallShader",void 0),(0,r.Z)(this,"emptyShader",void 0),(0,r.Z)(this,"world",void 0),(0,r.Z)(this,"startTime",Date.now()),(0,r.Z)(this,"mainMesh",void 0),(0,r.Z)(this,"drawBufferTextureUv",void 0),(0,r.Z)(this,"framebuffer",void 0),(0,r.Z)(this,"bufferTextureSize",new y),(0,r.Z)(this,"sourceBufferTexture",null),(0,r.Z)(this,"targetBufferTexture",null),(0,r.Z)(this,"config",{layers:{background:!0,walls:!0,cells:!0}}),this.shaderManager=e,this.backgroundShader=t,this.cellShader=n,this.wallShader=i,this.emptyShader=s,this.world=a,this.mainMesh=this.createMainMesh(),this.drawBufferTextureUv=this.createDrawBufferTextureUv(),this.framebuffer=e.gl.createFramebuffer(),this.autoUpdateDrawBufferTexture()}static init(e,t=null){const n=o.init(e),i=n.newShader(d,u),s=n.newShader(d,h),a=n.newShader(d,m),r=n.newShader(d,f);return new M(n,i,s,a,r,t)}render(){const e=this.shaderManager.gl;this.setDrawToBufferTexture(),this.swapBuffers(),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),this.config.layers.background&&this.renderBackground(),this.config.layers.cells&&this.renderCells(),this.config.layers.walls&&this.renderWalls(),this.renderBufferToCanvas()}project(e){const t=this.buildCameraTransform(),n=l.U_(t,t);return c.fF(c.Ue(),e,n)}unproject(e){return c.fF(c.Ue(),e,this.buildCameraTransform())}destroy(){this.shaderManager.destroy()}renderBufferToCanvas(){const e=this.shaderManager.gl;e.useProgram(this.emptyShader),this.setupVertexShader(this.emptyShader),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.bindTexture(e.TEXTURE_2D,this.sourceBufferTexture),e.uniform1i(e.getUniformLocation(this.emptyShader,"image"),0),this.setDrawToCanvas(),e.drawArrays(e.TRIANGLE_STRIP,0,4)}renderWalls(){const e=this.shaderManager.gl;e.useProgram(this.wallShader),this.setupVertexShader(this.wallShader);const t=this.buildViewTransform();e.uniformMatrix4fv(e.getUniformLocation(this.wallShader,"viewMatrix"),!1,t),e.uniform2f(e.getUniformLocation(this.wallShader,"imageSize"),this.bufferTextureSize.x,this.bufferTextureSize.y);for(const n of this.world.walls.values())e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.bindTexture(e.TEXTURE_2D,this.sourceBufferTexture),e.uniform1i(e.getUniformLocation(this.wallShader,"image"),0),e.uniform2f(e.getUniformLocation(this.wallShader,"wall.a"),n.a.x,n.a.y),e.uniform2f(e.getUniformLocation(this.wallShader,"wall.b"),n.b.x,n.b.y),this.setDrawToBufferTexture(),e.drawArrays(e.TRIANGLE_STRIP,0,4),this.swapBuffers()}renderCells(){if(!this.world)return;const e=this.shaderManager.gl;e.useProgram(this.cellShader),this.setupVertexShader(this.cellShader),e.uniform1f(e.getUniformLocation(this.cellShader,"time"),(Date.now()-this.startTime)/1e3);const t=this.buildViewTransform();e.uniformMatrix4fv(e.getUniformLocation(this.cellShader,"viewMatrix"),!1,t),e.uniform2f(e.getUniformLocation(this.cellShader,"imageSize"),this.bufferTextureSize.x,this.bufferTextureSize.y);for(const n of this.world.cells.values()){const t=n.aabb,[[i,s],[a,r]]=[this.project([t.min.x,t.min.y]),this.project([t.max.x,t.max.y])];if(a<0||r<0||i>e.drawingBufferWidth||s>e.drawingBufferHeight)continue;const o=M.cellPigmentsToRgba(n.genome.cyanPigment,n.genome.magentaPigment,n.genome.yellowPigment,n.genome.whitePigment);e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.bindTexture(e.TEXTURE_2D,this.sourceBufferTexture),e.uniform1i(e.getUniformLocation(this.cellShader,"image"),0),e.uniform1i(e.getUniformLocation(this.cellShader,"cell.id"),n.id),e.uniform2f(e.getUniformLocation(this.cellShader,"cell.center"),n.center.x,n.center.y),e.uniform2f(e.getUniformLocation(this.cellShader,"cell.speed"),n.speed.x,n.speed.y),e.uniform1f(e.getUniformLocation(this.cellShader,"cell.mass"),n.mass),e.uniform1f(e.getUniformLocation(this.cellShader,"cell.angle"),n.angle),e.uniform1f(e.getUniformLocation(this.cellShader,"cell.radius"),n.radius),e.uniform4f(e.getUniformLocation(this.cellShader,"cell.bodyRgba"),...o);let l=[];this.world.circleCast(n.center,n.radius).forEach((e=>{if(e instanceof _){const t=E.findCirclesIntersections(n.center,n.radius,e.center,e.radius);l.push({a:t[0],b:t[1]})}else e instanceof T&&l.push({a:e.a,b:e.b})})),l=l.slice(0,32),l.forEach(((t,n)=>{e.uniform2f(e.getUniformLocation(this.cellShader,`obstacles[${n}].a`),t.a.x,t.a.y),e.uniform2f(e.getUniformLocation(this.cellShader,`obstacles[${n}].b`),t.b.x,t.b.y)})),e.uniform1i(e.getUniformLocation(this.cellShader,"obstaclesSize"),l.length),this.setDrawToBufferTexture(),e.drawArrays(e.TRIANGLE_STRIP,0,4),this.swapBuffers()}}setupVertexShader(e){const t=this.shaderManager.gl,n=t.getAttribLocation(e,"vertexPosition");t.bindBuffer(t.ARRAY_BUFFER,this.mainMesh),t.vertexAttribPointer(n,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(n);const i=t.getAttribLocation(e,"textureCoordinate");t.enableVertexAttribArray(i),t.bindBuffer(t.ARRAY_BUFFER,this.drawBufferTextureUv),t.vertexAttribPointer(i,2,t.FLOAT,!1,0,0)}renderBackground(){if(!this.world)return;const e=this.shaderManager.gl;e.useProgram(this.backgroundShader),this.setupVertexShader(this.backgroundShader);const t=this.buildViewTransform();e.uniformMatrix4fv(e.getUniformLocation(this.backgroundShader,"viewMatrix"),!1,t),e.uniform1f(e.getUniformLocation(this.backgroundShader,"time"),(Date.now()-this.startTime)/1e3),e.uniform2f(e.getUniformLocation(this.backgroundShader,"areaSize"),this.world.width,this.world.height),e.uniform1f(e.getUniformLocation(this.backgroundShader,"lightIntensity"),this.world.lightIntensity),this.setDrawToBufferTexture(),e.drawArrays(e.TRIANGLE_STRIP,0,4),this.swapBuffers()}buildCameraTransform(){if(!this.world)throw new Error("Can't build camera transform: the world state is not set in renderer!");const e=this.shaderManager.gl.canvas.width,t=this.shaderManager.gl.canvas.height,n=l.Ue(),i=this.world.camera,s=0!=t?i.height/t:1;return l.bA(n,n,[s,s,1]),l.Iu(n,n,[i.center.x/s-e/2,i.center.y/s-t/2,0]),n}buildViewTransform(){const e=this.shaderManager.gl.canvas.height,t=this.buildCameraTransform();return l.bA(t,t,[1,-1,1]),l.Iu(t,t,[0,-e,0]),t}autoUpdateDrawBufferTexture(){if(this.drawBufferTextureNeedsUpdate()){const e=this.shaderManager.gl;e.deleteTexture(this.sourceBufferTexture),e.deleteTexture(this.targetBufferTexture);const t=this.shaderManager.gl.drawingBufferWidth,n=this.shaderManager.gl.drawingBufferHeight;this.sourceBufferTexture=this.shaderManager.newTexture(t,n),this.targetBufferTexture=this.shaderManager.newTexture(t,n),this.bufferTextureSize=new y(t,n)}}drawBufferTextureNeedsUpdate(){return this.bufferTextureSize.x!=this.shaderManager.gl.drawingBufferWidth||this.bufferTextureSize.y!=this.shaderManager.gl.drawingBufferHeight}setDrawToBufferTexture(){this.autoUpdateDrawBufferTexture();const e=this.shaderManager.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.targetBufferTexture,0)}setDrawToCanvas(){const e=this.shaderManager.gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}swapBuffers(){const e=this.sourceBufferTexture;this.sourceBufferTexture=this.targetBufferTexture,this.targetBufferTexture=e}createDrawBufferTextureUv(){return this.shaderManager.newArrayBuffer([1,1,0,1,1,0,0,0])}createMainMesh(){return this.shaderManager.newArrayBuffer([1,1,-1,1,1,-1,-1,-1])}static cellPigmentsToRgba(e,t,n,i){const[s,a,r]=[1-e,1-t,1-n],o=1-(1-e)*(1-t)*(1-n)*(1-i);return[s,a,r,o]}}class U{constructor(e,t,n,i,s){(0,r.Z)(this,"type",void 0),(0,r.Z)(this,"screenX",void 0),(0,r.Z)(this,"screenY",void 0),(0,r.Z)(this,"worldX",void 0),(0,r.Z)(this,"worldY",void 0),this.type=e,this.screenX=t,this.screenY=n,this.worldX=i,this.worldY=s}}const C=["onTouchstart","onTouchmove","onTouchend","onWheel"];var P=(0,s.aZ)({__name:"WorldViewer",setup(e,{emit:t}){const n=.005,r=(0,a.iH)(),o=(0,a.iH)();let l,c,d,u,h,m=(0,s.f3)("world");const f={dragMode:!1,lastMouseWorldPoint:[0,0]};function g(e){const t=m.camera;e.deltaY>0?t.height*=1+e.deltaY*n:t.height*=1/(1-e.deltaY*n),t.height<1&&(t.height=1)}function v(e){if(1==e.touches.length){let n;switch(e.type){case"touchstart":n="mousedown";break;case"touchmove":n="mousemove";break;case"touchend":n="mouseup";break}if(n){const{clientX:i,clientY:s}=e.touches[0],a=window.devicePixelRatio,[r,o]=[i*a,s*a];let[l,c]=d.unproject([r,o]);const u=new U(`world-${n}`,r,o,l,c);w(u),t(u.type,u)}}}function p(e){const n=window.devicePixelRatio,[i,s]=[e.x*n,e.y*n];let[a,r]=d.unproject([i,s]);const o=new U(`world-${e.type}`,i,s,a,r);w(o),t(o.type,o)}function w(e){if("world-mousedown"===e.type&&(f.dragMode=!0,f.lastMouseWorldPoint=[e.worldX,e.worldY]),"world-mousemove"===e.type&&f.dragMode){const[t,n]=f.lastMouseWorldPoint;m.camera.center.x+=t-e.worldX,m.camera.center.y+=n-e.worldY,[e.worldX,e.worldY]=d.unproject([e.screenX,e.screenY]),f.lastMouseWorldPoint=[e.worldX,e.worldY]}"world-mouseup"!==e.type&&"world-mouseleave"!==e.type||(f.dragMode=!1)}function x(){d.render(),h=window.requestAnimationFrame(x)}function b(){const e=window.devicePixelRatio,{width:t,height:n}=c.getBoundingClientRect();l.width=Math.round(t*e),l.height=Math.round(n*e),d.render()}return(0,s.bv)((()=>{l=r.value,c=o.value,d=M.init(l,m),u=new ResizeObserver(b),u.observe(l),x()})),(0,s.Jd)((()=>{u.disconnect(),window.cancelAnimationFrame(h),d.destroy()})),(e,t)=>((0,s.wg)(),(0,s.iD)("div",{class:"c-world-viewer",ref_key:"containerRef",ref:o},[(0,s._)("canvas",{class:"canvas",ref_key:"canvasRef",ref:r,onClick:p,onMousedown:p,onMouseup:p,onMousemove:p,onMouseleave:p,onTouchstart:(0,i.iM)(v,["prevent"]),onTouchmove:(0,i.iM)(v,["prevent"]),onTouchend:(0,i.iM)(v,["prevent"]),onWheel:(0,i.iM)(g,["prevent"])},null,40,C)],512))}});const I=P;var L=I,A=n.p+"img/genome-editor.fa52f771.svg",R=n.p+"img/settings.b0e7c0b3.svg",Z=n(4887);const D={class:"c-tabbed-panel"},B={class:"tabs"},V={class:"body"};var W=(0,s.aZ)({__name:"PropertiesTabbedPanel",setup(e){const t=(0,a.iH)(null),n=320;let i=0;const r=(0,a.iH)(300),o=(0,a.iH)(r.value);function l(e){i=e.clientX,c()}function c(){window.addEventListener("mousemove",d),window.addEventListener("mouseleave",u),window.addEventListener("mouseup",u)}function d(e){if(0===e.screenX)return;let t=i-e.clientX;o.value=r.value+t,o.value<n&&(o.value=n)}function u(){r.value=o.value,window.removeEventListener("mousemove",d),window.removeEventListener("mouseleave",u),window.removeEventListener("mouseup",u)}return(0,s.JJ)("activeTabName",t),(e,t)=>((0,s.wg)(),(0,s.iD)("div",D,[(0,s._)("div",{class:"tabbed-panel",draggable:"false",style:(0,Z.j5)({width:`${o.value}px`,minWidth:`${n}px`})},[(0,s._)("div",B,[(0,s.WI)(e.$slots,"tabs")]),(0,s._)("div",V,[(0,s.WI)(e.$slots,"bodies"),(0,s._)("div",{class:"resize-handle",onMousedown:l},null,32)])],4)]))}});const k=W;var F=k;const O=["disabled"];var N=(0,s.aZ)({__name:"HudButton",props:{active:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},borderRadius:{default:"4px"},borderWidth:{default:"1px"}},setup(e){const t=e;(0,i.sj)((e=>({"70e98800":(0,a.SU)(n),"69d2b898":(0,a.SU)(r)})));let n=(0,s.Fl)((()=>t.borderRadius.replaceAll("default","4px"))),r=(0,s.Fl)((()=>t.borderWidth.replaceAll("default","1px")));return(t,n)=>((0,s.wg)(),(0,s.iD)("button",{class:(0,Z.C_)(["c-button",{active:e.active}]),disabled:e.disabled},[(0,s.WI)(t.$slots,"default")],10,O))}});const H=N;var G=H,Y=(0,s.aZ)({__name:"PropertiesTab",props:["name"],setup(e){const t=e,n=(0,s.f3)("activeTabName");function i(){n.value==t.name?n.value=null:n.value=t.name}return(t,r)=>((0,s.wg)(),(0,s.j4)(G,{class:"c-properties-tab",active:(0,a.SU)(n)===e.name,onClick:i},{default:(0,s.w5)((()=>[(0,s.WI)(t.$slots,"default")])),_:3},8,["active"]))}});const X=Y;var j=X;const z={key:0,class:"body-wr"};var K=(0,s.aZ)({__name:"PropertiesTabBody",props:["name"],setup(e){const t=e,n=(0,s.f3)("activeTabName",(0,a.iH)(null));return(e,i)=>(0,a.SU)(n)===t.name?((0,s.wg)(),(0,s.iD)("div",z,[(0,s.WI)(e.$slots,"default")])):(0,s.kq)("",!0)}});const J=K;var $=J;const q={class:"section-wr"},Q={key:0,class:"section-title"},ee={class:"section-content"};var te=(0,s.aZ)({__name:"PropertiesSection",props:["title"],setup(e){const t=e;return(e,n)=>((0,s.wg)(),(0,s.iD)("div",q,[t.title?((0,s.wg)(),(0,s.iD)("div",Q,(0,Z.zw)(t.title),1)):(0,s.kq)("",!0),(0,s._)("div",ee,[(0,s.WI)(e.$slots,"default")])]))}}),ne=n(5312);const ie=(0,ne.Z)(te,[["__scopeId","data-v-22faf50d"]]);var se=ie;const ae={class:"c-number-slider"},re=["disabled","min","max","step"];var oe=(0,s.aZ)({__name:"NumberSlider",props:{min:null,max:null,step:null,disabled:{type:Boolean},modelValue:null},emits:["update:modelValue"],setup(e,{emit:t}){const n=e,r=(0,a.iH)(n.modelValue||0);return(0,s.YP)(n,(()=>{null!=n.modelValue&&(r.value=n.modelValue)})),(0,s.YP)(r,(()=>{t("update:modelValue",r.value)})),(t,n)=>((0,s.wg)(),(0,s.iD)("div",ae,[(0,s.wy)((0,s._)("input",{class:"input",type:"range",disabled:e.disabled,min:e.min,max:e.max,step:e.step,"onUpdate:modelValue":n[0]||(n[0]=e=>r.value=e)},null,8,re),[[i.nr,r.value]])]))}});const le=(0,ne.Z)(oe,[["__scopeId","data-v-39e8fa0e"]]);var ce=le;const de={class:"c-slider-with-number-input"},ue={class:"slider-with-number-input"},he=["disabled"];var me=(0,s.aZ)({__name:"SliderWithNumberInput",props:{min:null,max:null,step:null,disabled:{type:Boolean},modelValue:null},emits:["update:modelValue"],setup(e,{emit:t}){const n=e,r=(0,a.iH)(),o=(0,a.iH)(n.modelValue||0);return(0,s.YP)(n,(()=>{null!=n.modelValue&&(o.value=n.modelValue)})),(0,s.YP)(o,(()=>{t("update:modelValue",o.value)})),(t,n)=>((0,s.wg)(),(0,s.iD)("div",de,[(0,s._)("div",ue,[(0,s.Wm)(ce,{class:"slider",min:e.min,max:e.max,step:e.step,disabled:e.disabled,modelValue:o.value,"onUpdate:modelValue":n[0]||(n[0]=e=>o.value=e),modelModifiers:{number:!0}},null,8,["min","max","step","disabled","modelValue"]),(0,s.wy)((0,s._)("input",{class:"text-input",type:"text",ref_key:"textInput",ref:r,"onUpdate:modelValue":n[1]||(n[1]=e=>o.value=e),disabled:e.disabled,onFocus:n[2]||(n[2]=e=>(0,a.SU)(r).select()),onKeydown:[n[3]||(n[3]=(0,i.D2)((e=>(0,a.SU)(r).blur()),["enter"])),n[4]||(n[4]=(0,i.D2)((e=>(0,a.SU)(r).blur()),["esc"]))]},null,40,he),[[i.nr,o.value,void 0,{number:!0}]])])]))}});const fe=me;var ge=fe;const ve={class:"c-input-label"};function pe(e,t){return(0,s.wg)(),(0,s.iD)("div",ve,[(0,s.WI)(e.$slots,"default")])}const we={},xe=(0,ne.Z)(we,[["render",pe]]);var be=xe,ye=(0,s.aZ)({__name:"WorldSettings",setup(e){const t=(0,s.f3)("world");return(e,n)=>((0,s.wg)(),(0,s.j4)(se,{class:"c-world-settings-tab-body",title:"World settings"},{default:(0,s.w5)((()=>[(0,s.Wm)(be,null,{default:(0,s.w5)((()=>[(0,s.Uk)("Gravity")])),_:1}),(0,s.Wm)(ge,{class:"slider-input",min:-5,max:5,step:.01,modelValue:(0,a.SU)(t).gravity.y,"onUpdate:modelValue":n[0]||(n[0]=e=>(0,a.SU)(t).gravity.y=e),modelModifiers:{number:!0}},null,8,["step","modelValue"]),(0,s.Wm)(be,null,{default:(0,s.w5)((()=>[(0,s.Uk)("Density")])),_:1}),(0,s.Wm)(ge,{class:"slider-input",min:0,max:1.5,step:.01,modelValue:(0,a.SU)(t).density,"onUpdate:modelValue":n[1]||(n[1]=e=>(0,a.SU)(t).density=e),modelModifiers:{number:!0},disabled:!0},null,8,["max","step","modelValue"]),(0,s.Wm)(be,null,{default:(0,s.w5)((()=>[(0,s.Uk)("Viscosity")])),_:1}),(0,s.Wm)(ge,{class:"slider-input",min:0,max:.8,step:.01,modelValue:(0,a.SU)(t).viscosity,"onUpdate:modelValue":n[2]||(n[2]=e=>(0,a.SU)(t).viscosity=e),modelModifiers:{number:!0}},null,8,["max","step","modelValue"]),(0,s.Wm)(be,null,{default:(0,s.w5)((()=>[(0,s.Uk)("Light intensity")])),_:1}),(0,s.Wm)(ge,{class:"slider-input",min:0,max:.8,step:.01,modelValue:(0,a.SU)(t).lightIntensity,"onUpdate:modelValue":n[3]||(n[3]=e=>(0,a.SU)(t).lightIntensity=e),modelModifiers:{number:!0},disabled:!0},null,8,["max","step","modelValue"])])),_:1}))}});const Se=ye;var _e,Te=Se;class Ee{constructor(e,t){(0,r.Z)(this,"center",void 0),(0,r.Z)(this,"mass",void 0),(0,r.Z)(this,"id",-1),this.center=e,this.mass=t}get radius(){return Math.sqrt(this.mass/Math.PI)/Ee.FOOD_DENSITY}}(0,r.Z)(Ee,"FOOD_DENSITY",4),function(e){e[e["PHAGOCYTE"]=0]="PHAGOCYTE",e[e["FLAGELLOCYTE"]=1]="FLAGELLOCYTE"}(_e||(_e={}));var Me=_e;class Ue{constructor(e=Me.FLAGELLOCYTE,t=0,n=0,i=0,s=0,a=0,o=0,l=0,c=0,d=0,u=!1,h=!1,m=!1,f=0){(0,r.Z)(this,"type",void 0),(0,r.Z)(this,"cyanPigment",void 0),(0,r.Z)(this,"magentaPigment",void 0),(0,r.Z)(this,"yellowPigment",void 0),(0,r.Z)(this,"whitePigment",void 0),(0,r.Z)(this,"hardness",void 0),(0,r.Z)(this,"splitMass",void 0),(0,r.Z)(this,"splitAngle",void 0),(0,r.Z)(this,"child1Angle",void 0),(0,r.Z)(this,"child2Angle",void 0),(0,r.Z)(this,"stickOnSplit",void 0),(0,r.Z)(this,"child1KeepConnections",void 0),(0,r.Z)(this,"child2KeepConnections",void 0),(0,r.Z)(this,"nutritionPriority",void 0),(0,r.Z)(this,"flagellumForce",8),(0,r.Z)(this,"children",[this,this]),(0,r.Z)(this,"deepCopy",this.copyRecursive),this.type=e,this.cyanPigment=t,this.magentaPigment=n,this.yellowPigment=i,this.whitePigment=s,this.hardness=a,this.splitMass=o,this.splitAngle=l,this.child1Angle=c,this.child2Angle=d,this.stickOnSplit=u,this.child1KeepConnections=h,this.child2KeepConnections=m,this.nutritionPriority=f}applyRadiationLocally(){}static newNullGenome(){return new Ue}static newSampleGenome(){const e=new Ue;return e.type=Me.FLAGELLOCYTE,e.hardness=.6,e.splitMass=350,e.child1KeepConnections=!0,e.child2KeepConnections=!0,e.nutritionPriority=1,[e.cyanPigment,e.magentaPigment,e.yellowPigment,e.whitePigment]=this.getRandomCellPigments(),e}static getRandomCellPigments(){const e=[Math.round(Math.random()/2*100)/100,Math.round(100*Math.random())/100,0,0];for(let t=0;t<e.length;t++){const n=Math.floor(Math.random()*e.length);[e[t],e[n]]=[e[n],e[t]]}return e}copyRecursive(e=(new Map).set(null,null)){const t=new Ue;return t.type=this.type,t.cyanPigment=this.cyanPigment,t.magentaPigment=this.magentaPigment,t.yellowPigment=this.yellowPigment,t.whitePigment=this.whitePigment,t.hardness=this.hardness,t.splitMass=this.splitMass,t.splitAngle=this.splitAngle,t.child1Angle=this.child1Angle,t.child2Angle=this.child2Angle,t.stickOnSplit=this.stickOnSplit,t.child1KeepConnections=this.child1KeepConnections,t.child2KeepConnections=this.child2KeepConnections,t.nutritionPriority=this.nutritionPriority,t.flagellumForce=this.flagellumForce,e.set(this,t),t.children=[e.has(this.children[0])?e.get(this.children[0]):this.children[0].copyRecursive(e),e.has(this.children[1])?e.get(this.children[1]):this.children[1].copyRecursive(e)],t}findAllGenomes(){const e=new Array,t=new Set;while(0!=e.length)e.pop().children.forEach((n=>{t.has(n)||(e.push(n),t.add(n))}));return t}applyRadiationRecursive(){}}class Ce{constructor(e,t){(0,r.Z)(this,"center",void 0),(0,r.Z)(this,"height",void 0),this.center=e,this.height=t}}(0,r.Z)(Ce,"NULL",new Ce(new y,0));class Pe{constructor(e,t,n,i,s,a,o,l=Ce.NULL){(0,r.Z)(this,"width",void 0),(0,r.Z)(this,"height",void 0),(0,r.Z)(this,"gravity",void 0),(0,r.Z)(this,"density",void 0),(0,r.Z)(this,"viscosity",void 0),(0,r.Z)(this,"radiation",void 0),(0,r.Z)(this,"lightIntensity",void 0),(0,r.Z)(this,"camera",void 0),(0,r.Z)(this,"food",new Map),(0,r.Z)(this,"cells",new Map),(0,r.Z)(this,"walls",new Map),(0,r.Z)(this,"idCounter",0),this.width=e,this.height=t,this.gravity=n,this.density=i,this.viscosity=s,this.radiation=a,this.lightIntensity=o,this.camera=l}newId(){return this.idCounter++}add(e){-1==e.id&&(e.id=this.newId()),e instanceof _&&this.cells.set(e.id,e),e instanceof Ee&&this.food.set(e.id,e),e instanceof T&&this.walls.set(e.id,e)}remove(e){if(this.cells.delete(e.id),this.food.delete(e.id),this.walls.delete(e.id),e instanceof _)for(const t of e.connections.keys())this.cells.get(t)?.connections.delete(e.id)}getLightIntensityAtPoint(e){}getRadiationIntensityAtPoint(e){}rayCast(e,t){const n=[];for(const i of this.walls.values())E.findLinesIntersection([i.a,i.b],[e,t])&&n.push(i);for(const i of this.cells.values())0!=E.findLineAndCircleIntersections(i.center,i.radius,e,t).length&&n.push(i);for(const i of this.food.values())0!=E.findLineAndCircleIntersections(i.center,i.radius,e,t).length&&n.push(i);return n}circleCast(e,t){const n=[];for(const i of this.walls.values())0!=E.findLineAndCircleIntersections(e,t,i.a,i.b).length&&n.push(i);for(const i of this.cells.values())0!=E.findCirclesIntersections(e,t,i.center,i.radius).length&&n.push(i);for(const i of this.food.values())0!=E.findCirclesIntersections(e,t,i.center,i.radius).length&&n.push(i);return n}static getDefault(){return new Pe(0,0,new y,0,0,0,0)}}(0,r.Z)(Pe,"TEMPORARY_DEBUG",(()=>{const e=new Pe(800,600,new y(0,4),0,.2,0,0,new Ce(new y(0,0),800));for(let t=0;t<50;t++)e.add(new _(new y(50+Math.random()*(e.width-100),50+200*Math.random()),new y,400,0,0,Ue.newSampleGenome()));return e.add(new T(new y(0,0),new y(0,e.height))),e.add(new T(new y(0,e.height),new y(e.width,e.height))),e.add(new T(new y(e.width,e.height),new y(e.width,0))),e.add(new T(new y(e.width,0),new y(0,0))),e})());const Ie={class:"c-cell-genome-preview"};var Le=(0,s.aZ)({__name:"CellGenomePreview",props:{genome:null},setup(e){const t=e,n=(0,a.iH)();let i,r;function o(){const e=Pe.getDefault();if(t.genome){const n=new _(new y,new y,300,Math.PI/4,0,t.genome);e.cells.set(0,n),e.camera=new Ce(new y,3*n.radius)}r.world=e}function l(){const e=window.devicePixelRatio,{width:t,height:i}=n.value.getBoundingClientRect();n.value.width=Math.round(t*e),n.value.height=Math.round(i*e),r.render()}return(0,s.bv)((()=>{r=M.init(n.value),r.config.layers.background=!1,i=new ResizeObserver(l),i.observe(n.value),o(),r.render()})),(0,s.Jd)((()=>{i.disconnect(),r.destroy()})),(0,s.YP)(t,(()=>{o(),r.render()})),(e,t)=>((0,s.wg)(),(0,s.iD)("div",Ie,[(0,s._)("canvas",{class:"canvas",ref_key:"canvas",ref:n},null,512)]))}});const Ae=Le;var Re=Ae;const Ze={class:"c-genome-selector"},De={class:"select-head"},Be=["onKeydown"],Ve={class:"dropdown"},We=["onClick"],ke={class:"dropdown-item__preview-wr"},Fe={class:"dropdown-item__name"},Oe=(0,s._)("div",{class:"dropdown-item__controls"},null,-1),Ne=(0,s._)("div",{class:"new-item-button"},null,-1);var He=(0,s.aZ)({__name:"GenomeSelector",props:{library:null,modelValue:null},emits:["update:modelValue"],setup(e,{emit:t}){const n=e,r=(0,a.iH)(n.modelValue?n.modelValue.name:""),o=(0,a.iH)(!1),l=(0,a.iH)(null),c=(0,s.Fl)((()=>l.value&&r.value===l.value.name?n.library.entries:n.library.search(r.value)));function d(e){o.value=!0;const t=e.target;t.select()}function u(e){l.value=e,o.value=!1}function h(){o.value=!1,m()}function m(){null==l.value?r.value="":r.value=l.value.name}return(0,s.YP)(l,(()=>{t("update:modelValue",l.value),m()})),(0,s.YP)(n,(()=>{n.modelValue&&(l.value=n.modelValue),m()})),(t,n)=>{const m=(0,s.Q2)("click-outside");return(0,s.wg)(),(0,s.iD)("div",Ze,[(0,s.wy)(((0,s.wg)(),(0,s.iD)("div",{class:(0,Z.C_)({"dropdown-opened":o.value})},[(0,s.Wm)(be,null,{default:(0,s.w5)((()=>[(0,s.Uk)("Genome to edit")])),_:1}),(0,s._)("div",De,[l.value?((0,s.wg)(),(0,s.j4)(Re,{key:0,class:"select-head__preview",genome:e.modelValue?.genome},null,8,["genome"])):(0,s.kq)("",!0),(0,s.wy)((0,s._)("input",{class:"select-head__name-input",placeholder:"Select genome","onUpdate:modelValue":n[0]||(n[0]=e=>r.value=e),onFocus:d,onKeydown:(0,i.D2)(h,["esc"])},null,40,Be),[[i.nr,r.value]]),(0,s._)("button",{class:"select-head__dropdown-trigger",onClick:n[1]||(n[1]=e=>o.value=!o.value)})]),(0,s.wy)((0,s._)("div",Ve,[((0,s.wg)(!0),(0,s.iD)(s.HY,null,(0,s.Ko)((0,a.SU)(c),(e=>((0,s.wg)(),(0,s.iD)("div",{class:"dropdown-item",key:e.name,onClick:()=>u(e)},[(0,s._)("div",ke,[(0,s.Wm)(Re,{class:"dropdown-item__preview",genome:e.genome},null,8,["genome"])]),(0,s._)("div",Fe,(0,Z.zw)(e.name),1),Oe],8,We)))),128)),Ne],512),[[i.F8,o.value]])],2)),[[m,h]])])}}});const Ge=He;var Ye=Ge;const Xe={class:"c-properties-subheader"},je={class:"text"};function ze(e,t){return(0,s.wg)(),(0,s.iD)("div",Xe,[(0,s._)("span",je,[(0,s.WI)(e.$slots,"default")])])}const Ke={},Je=(0,ne.Z)(Ke,[["render",ze]]);var $e=Je;const qe={class:"c-genome-pigment-color-droplet-icon"};var Qe=(0,s.aZ)({__name:"GenomePigmentColorDropletIcon",props:{color:{type:String,default:"white"},value:{type:Number,default:1}},setup(e){const t=e,n=(0,a.iH)();let i,r=null;function o(){i=new ResizeObserver(c),i.observe(n.value)}function l(){i.disconnect()}function c(){const e=n.value,t=window.devicePixelRatio,{width:i,height:s}=e.getBoundingClientRect();e.width=Math.round(i*t),e.height=Math.round(s*t),d()}function d(){const e=n.value,{width:i,height:s}=e;r=r||e.getContext("2d");const a=r.createLinearGradient(.5*i,.2*s,.5*i,.85*s),o=Math.min(1,Math.max(0,t.value));a.addColorStop(0,"transparent"),a.addColorStop(1-o,"transparent"),a.addColorStop(1-o,t.color),a.addColorStop(1,t.color),r.clearRect(0,0,i,s),r.strokeStyle=t.color,r.fillStyle=a,r.lineWidth=2,r.beginPath(),r.moveTo(.5*i,.2*s),r.lineTo(.75*i,.6*s),r.arc(.5*i,.6*s,.25*i,0,Math.PI),r.lineTo(.5*i,.2*s),r.stroke(),r.fill()}return(0,s.YP)(t,d),(0,s.bv)(o),(0,s.Jd)(l),(e,t)=>((0,s.wg)(),(0,s.iD)("div",qe,[(0,s._)("canvas",{class:"canvas",ref_key:"canvasRef",ref:n},null,512)]))}});const et=Qe;var tt=et;const nt={class:"c-genome-pigments-editor"},it={class:"pigments-view"};var st=(0,s.aZ)({__name:"GenomePigmentsEditor",setup(e){const t=(0,s.f3)("selectedGenomeEntry"),n=(0,s.Fl)((()=>t.value?t.value.genome:Ue.newNullGenome()));return(e,i)=>((0,s.wg)(),(0,s.iD)("div",nt,[(0,s.Wm)(be,{class:"label"},{default:(0,s.w5)((()=>[(0,s.Uk)("Cyan")])),_:1}),(0,s.Wm)(ge,{class:"input",min:0,max:1,step:.01,disabled:!(0,a.SU)(t),modelValue:(0,a.SU)(n).cyanPigment,"onUpdate:modelValue":i[0]||(i[0]=e=>(0,a.SU)(n).cyanPigment=e)},null,8,["step","disabled","modelValue"]),(0,s.Wm)(be,{class:"label"},{default:(0,s.w5)((()=>[(0,s.Uk)("Magenta")])),_:1}),(0,s.Wm)(ge,{class:"input",min:0,max:1,step:.01,disabled:!(0,a.SU)(t),modelValue:(0,a.SU)(n).magentaPigment,"onUpdate:modelValue":i[1]||(i[1]=e=>(0,a.SU)(n).magentaPigment=e)},null,8,["step","disabled","modelValue"]),(0,s.Wm)(be,{class:"label"},{default:(0,s.w5)((()=>[(0,s.Uk)("Yellow")])),_:1}),(0,s.Wm)(ge,{class:"input",min:0,max:1,step:.01,disabled:!(0,a.SU)(t),modelValue:(0,a.SU)(n).yellowPigment,"onUpdate:modelValue":i[2]||(i[2]=e=>(0,a.SU)(n).yellowPigment=e)},null,8,["step","disabled","modelValue"]),(0,s.Wm)(be,{class:"label"},{default:(0,s.w5)((()=>[(0,s.Uk)("White")])),_:1}),(0,s.Wm)(ge,{class:"input",min:0,max:1,step:.01,disabled:!(0,a.SU)(t),modelValue:(0,a.SU)(n).whitePigment,"onUpdate:modelValue":i[3]||(i[3]=e=>(0,a.SU)(n).whitePigment=e)},null,8,["step","disabled","modelValue"]),(0,s._)("div",it,[(0,s.Wm)(tt,{class:"pigment-icon",color:"cyan",value:(0,a.SU)(n).cyanPigment},null,8,["value"]),(0,s.Wm)(tt,{class:"pigment-icon",color:"magenta",value:(0,a.SU)(n).magentaPigment},null,8,["value"]),(0,s.Wm)(tt,{class:"pigment-icon",color:"yellow",value:(0,a.SU)(n).yellowPigment},null,8,["value"]),(0,s.Wm)(tt,{class:"pigment-icon",color:"white",value:(0,a.SU)(n).whitePigment},null,8,["value"])])]))}});const at=st;var rt=at,ot=(0,s.aZ)({__name:"GenomeEditor",setup(e){return(e,t)=>((0,s.wg)(),(0,s.iD)("div",null,[(0,s.Wm)($e,null,{default:(0,s.w5)((()=>[(0,s.Uk)("Pigments")])),_:1}),(0,s.Wm)(rt),(0,s.Wm)($e,null,{default:(0,s.w5)((()=>[(0,s.Uk)("Children")])),_:1})]))}});const lt=ot;var ct=lt,dt=(0,s.aZ)({__name:"GenomeLibraryEditor",setup(e){const t=(0,s.f3)("genomeLibrary");let n=(0,a.iH)(null);return(0,s.JJ)("selectedGenomeEntry",n),(e,i)=>((0,s.wg)(),(0,s.j4)(se,{title:"Genome editor"},{default:(0,s.w5)((()=>[(0,s.Wm)(Ye,{library:(0,a.SU)(t),modelValue:(0,a.SU)(n),"onUpdate:modelValue":i[0]||(i[0]=e=>(0,a.dq)(n)?n.value=e:n=e)},null,8,["library","modelValue"]),(0,s.Wm)(ct)])),_:1}))}});const ut=dt;var ht=ut,mt=n.p+"img/pause.1dcf1ff8.svg",ft=n.p+"img/play.d5c321d8.svg";const gt={class:"c-time-control"},vt={key:0,class:"icon",src:mt,alt:"pause icon"},pt={key:1,class:"icon",src:ft,alt:"play icon"};var wt=(0,s.aZ)({__name:"TimeControl",setup(e){const t=(0,s.f3)("worldUpdater");function n(){t.value.simulationActive?t.value.pauseSimulation():t.value.startSimulation()}function i(e){t.value.simulationSpeed=e,t.value.startSimulation()}return(e,r)=>((0,s.wg)(),(0,s.iD)("div",gt,[(0,s.Wm)(G,{class:"button pause-play-button",onClick:n},{default:(0,s.w5)((()=>[(0,a.SU)(t).simulationActive?((0,s.wg)(),(0,s.iD)("img",vt)):((0,s.wg)(),(0,s.iD)("img",pt))])),_:1}),(0,s.Wm)(G,{class:"button play-1x-button","border-radius":"default 0 0 default","border-width":"default 0.5px default default",active:1===(0,a.SU)(t).simulationSpeed,onClick:r[0]||(r[0]=()=>i(1))},{default:(0,s.w5)((()=>[(0,s.Uk)(" x1 ")])),_:1},8,["active"]),(0,s.Wm)(G,{class:"button play-2x-button","border-radius":"0","border-width":"default 0.5px",active:2===(0,a.SU)(t).simulationSpeed,onClick:r[1]||(r[1]=()=>i(2))},{default:(0,s.w5)((()=>[(0,s.Uk)(" x2 ")])),_:1},8,["active"]),(0,s.Wm)(G,{class:"button play-5x-button","border-radius":"0.5px default default 0","border-width":"default default default 0.5px",active:5===(0,a.SU)(t).simulationSpeed,onClick:r[2]||(r[2]=()=>i(5))},{default:(0,s.w5)((()=>[(0,s.Uk)(" x5 ")])),_:1},8,["active"])]))}});const xt=wt;var bt=xt;const yt={class:"c-controls-panel"},St=(0,s._)("img",{class:"properties-tab__icon",src:A,alt:"Tab icon"},null,-1),_t=(0,s._)("img",{class:"properties-tab__icon",src:R,alt:"Tab icon"},null,-1),Tt={class:"tool-buttons-container"},Et=["src"];var Mt=(0,s.aZ)({__name:"HudPanel",setup(e){const t=(0,s.f3)("toolsManager");return(e,n)=>((0,s.wg)(),(0,s.iD)("div",yt,[(0,s.Wm)(F,{class:"properties-container"},{tabs:(0,s.w5)((()=>[(0,s.Wm)(j,{class:"properties-tab",name:"genome-editor"},{default:(0,s.w5)((()=>[St])),_:1}),(0,s.Wm)(j,{class:"properties-tab",name:"settings"},{default:(0,s.w5)((()=>[_t])),_:1})])),bodies:(0,s.w5)((()=>[(0,s.Wm)($,{name:"genome-editor"},{default:(0,s.w5)((()=>[(0,s.Wm)(ht)])),_:1}),(0,s.Wm)($,{name:"settings"},{default:(0,s.w5)((()=>[(0,s.Wm)(Te)])),_:1})])),_:1}),(0,s._)("div",Tt,[((0,s.wg)(!0),(0,s.iD)(s.HY,null,(0,s.Ko)((0,a.SU)(t).tools,(e=>((0,s.wg)(),(0,s.j4)(G,{class:"tool-button",key:e.name,disabled:!e.enabled,active:(0,a.SU)(t).currentTool===e,onClick:n=>(0,a.SU)(t).currentTool=e},{default:(0,s.w5)((()=>[(0,s._)("img",{class:"tool-button__icon",src:e.icon,alt:"Tool icon"},null,8,Et)])),_:2},1032,["disabled","active","onClick"])))),128))]),(0,s.Wm)(bt)]))}});const Ut=Mt;var Ct=Ut;class Pt{constructor(){(0,r.Z)(this,"entries",new Set)}search(e){const t=new Set;return this.entries.forEach((n=>{n.name.toLowerCase().includes(e.toLowerCase())&&t.add(n)})),t}}class It{constructor(e,t){(0,r.Z)(this,"name",void 0),(0,r.Z)(this,"genome",void 0),this.name=e,this.genome=t}}class Lt{}class At{constructor(e,t){(0,r.Z)(this,"tools",void 0),(0,r.Z)(this,"world",void 0),(0,r.Z)(this,"currentTool",void 0),this.tools=e,this.world=t,e.forEach((e=>e.init(this))),this.currentTool=e[0]}dispatchEvent(e){}}class Rt{constructor(){(0,r.Z)(this,"name","Add cell"),(0,r.Z)(this,"icon",n(1038)),(0,r.Z)(this,"enabled",!1),(0,r.Z)(this,"toolsManager",null)}init(e){this.toolsManager=e}onSelect(){}onUnselect(){}}class Zt{constructor(){(0,r.Z)(this,"name","Remove cell"),(0,r.Z)(this,"icon",n(4765)),(0,r.Z)(this,"enabled",!1)}init(e){}onSelect(){}onUnselect(){}}class Dt{constructor(){(0,r.Z)(this,"name","Selection"),(0,r.Z)(this,"icon",n(8611)),(0,r.Z)(this,"enabled",!0)}init(e){}onSelect(){}onUnselect(){}}class Bt{constructor(e,t){(0,r.Z)(this,"world",void 0),(0,r.Z)(this,"context",void 0),this.world=e,this.context=t}update(){this.context.cellsSpeedBuffer.clear(),this.context.cellsAngularSpeedBuffer.clear();for(const e of this.world.cells.values())this.context.cellsSpeedBuffer.set(e.id,e.speed),this.context.cellsAngularSpeedBuffer.set(e.id,e.angularSpeed)}}class Vt{constructor(){(0,r.Z)(this,"cellsSpeedBuffer",new Map),(0,r.Z)(this,"cellsAngularSpeedBuffer",new Map)}}class Wt{constructor(e,t){(0,r.Z)(this,"world",void 0),(0,r.Z)(this,"context",void 0),this.world=e,this.context=t}update(e){for(const t of this.world.cells.values()){this.processGravity(t,e),this.world.circleCast(t.center,t.radius).forEach((n=>{n instanceof T?this.processCellWallCollision(t,n,e):n instanceof _&&this.processCellsCollision(t,n,e)}));for(const n of t.connections.values())this.processCellConnection(t,n,e)}}processGravity(e,t){let n=this.context.cellsSpeedBuffer.get(e.id);n=n.plus(this.world.gravity.times(t)),this.context.cellsSpeedBuffer.set(e.id,n)}processCellWallCollision(e,t,n){const i=E.findLineAndCircleIntersections(e.center,e.radius,t.a,t.b);if(0!==i.length){const i=E.projectPointOntoLine(e.center,[t.a,t.b]),s=i.to(e.center).unit.times(e.radius-i.distance(e.center)),a=E.clamp(1-e.center.distance(i)/e.radius,0,1),r=Math.pow(e.genome.hardness*a+1,e.genome.hardness+1),o=this.context.cellsSpeedBuffer.get(e.id),l=o.plus(s.times(r*n));this.context.cellsSpeedBuffer.set(e.id,l)}}processCellsCollision(e,t,n){if(e.id!=t.id&&e.center.distance(t.center)<=e.radius+t.radius){const i=E.findCirclesIntersections(e.center,e.radius,t.center,t.radius),s=0!=i.length?i[0].plus(i[1]).div(2):e.center.plus(t.center).div(2),a=E.clamp(1-e.center.distance(s)/e.radius,0,1),r=e.mass+t.mass,o=e.mass/r,l=s.to(e.center).unit.times(e.radius-s.distance(e.center)),c=Math.pow(e.genome.hardness*a+1,e.genome.hardness+1),d=this.context.cellsSpeedBuffer.get(e.id),u=d.plus(l.times(c).plus(t.speed.times(o).minus(e.speed.times(1-o)).times(e.genome.hardness)).times(n));this.context.cellsSpeedBuffer.set(e.id,u)}}processCellConnection(e,t,n){const i=this.world.cells.get(t.partnerId);if(!i)return;const s=i.connections.get(e.id);if(s)for(let a=0;a<4;a++){const r=a*Math.PI/24-1.5*Math.PI/24,o=e.angle+t.angle+r,l=e.center.plus(y.unit(o).times(e.radius)).minus(y.unit(o).times(Wt.CELL_STICKINESS_DEPTH)),c=i.center.plus(y.unit(i.angle+s.angle-r).times(i.radius)).minus(y.unit(i.angle+s.angle-r).times(Wt.CELL_STICKINESS_DEPTH)),d=l.to(c).div(4).times(n);this.applyImpulse(e,l,d)}}applyImpulse(e,t,n){if(0==n.length)return;const i=t.to(e.center).angle,s=i-n.angle,a=e.center.distance(t),r=Math.sin(s)*a,o=1/(Math.pow(r/e.radius,2)+1),l=1-o,c=this.context.cellsSpeedBuffer.get(e.id),d=c.plus(n.times(o)),u=this.context.cellsAngularSpeedBuffer.get(e.id),h=u-Math.atan(n.length/r)*l;this.context.cellsSpeedBuffer.set(e.id,d),this.context.cellsAngularSpeedBuffer.set(e.id,h)}}(0,r.Z)(Wt,"CELL_STICKINESS_DEPTH",3);class kt{constructor(e,t){(0,r.Z)(this,"world",void 0),(0,r.Z)(this,"context",void 0),this.world=e,this.context=t}update(){this.context.cellsSpeedBuffer.forEach(((e,t)=>{const n=this.world.cells.get(t);n&&(n.speed=e)})),this.context.cellsAngularSpeedBuffer.forEach(((e,t)=>{const n=this.world.cells.get(t);n&&(n.angularSpeed=e)}))}}class Ft{constructor(e){(0,r.Z)(this,"world",void 0),this.world=e}update(e){this.world.cells.forEach((t=>{t.center=t.center.plus(t.speed.times(e)),t.angle=t.angle+t.angularSpeed*e,t.speed=t.speed.minus(t.speed.times(this.world.viscosity*e)),t.angularSpeed-=t.angularSpeed*this.world.viscosity*e}))}}class Ot{constructor(e){(0,r.Z)(this,"world",void 0),(0,r.Z)(this,"updateContext",void 0),(0,r.Z)(this,"updatePipeline",void 0),(0,r.Z)(this,"simulationSpeed",1),(0,r.Z)(this,"intervalId",-1),(0,r.Z)(this,"lastUpdateMillis",-1),this.world=e,this.updateContext=new Vt,this.updatePipeline=[new Bt(this.world,this.updateContext),new Wt(this.world,this.updateContext),new kt(this.world,this.updateContext),new Ft(this.world)]}get simulationActive(){return-1!=this.intervalId}startSimulation(){this.simulationActive||(this.intervalId=setInterval(this.intervalRoutine.bind(this),Ot.SIMULATION_TICK_FIXED_DELTA),this.lastUpdateMillis=Date.now())}pauseSimulation(){this.simulationActive&&clearInterval(this.intervalId),this.intervalId=-1}tick(e){for(const t of this.updatePipeline)t.update(e)}intervalRoutine(){const e=Date.now()-this.lastUpdateMillis,t=Math.round(e/Ot.SIMULATION_TICK_FIXED_DELTA),n=Math.min(Math.round(e*this.simulationSpeed/Ot.SIMULATION_TICK_FIXED_DELTA),10);for(let i=0;i<n;i++)this.tick(Ot.SIMULATION_TICK_FIXED_DELTA/1e3*Ot.SIMULATION_SPEED_FACTOR);this.lastUpdateMillis+=Ot.SIMULATION_TICK_FIXED_DELTA*t}}(0,r.Z)(Ot,"SIMULATION_TICK_FIXED_DELTA",16),(0,r.Z)(Ot,"SIMULATION_SPEED_FACTOR",5);var Nt=(0,s.aZ)({__name:"App",setup(e){const t=[new Dt,new Rt,new Zt],n=Pe.TEMPORARY_DEBUG,i=new Pt,r=new Ot(n),o=new Lt,l=new At(t,n);return i.entries.add(new It("my genome",Ue.newSampleGenome())),i.entries.add(new It("test",Ue.newSampleGenome())),i.entries.add(new It("aaaaaaaaa",Ue.newSampleGenome())),i.entries.add(new It("aboba",Ue.newSampleGenome())),(0,s.JJ)("world",n),(0,s.JJ)("worldUpdater",(0,a.iH)(r)),(0,s.JJ)("genomeLibrary",(0,a.iH)(i)),(0,s.JJ)("appPreferences",(0,a.iH)(o)),(0,s.JJ)("toolsManager",(0,a.iH)(l)),(e,t)=>((0,s.wg)(),(0,s.iD)(s.HY,null,[(0,s.Wm)(L),(0,s.Wm)(Ct,{class:"controls-panel"})],64))}});const Ht=Nt;var Gt=Ht;const Yt=(0,i.ri)(Gt);Yt.directive("click-outside",{mounted:function(e,t){e.clickOutsideEvent=function(n){e==n.target||e.contains(n.target)||t.value(n)},document.body.addEventListener("click",e.clickOutsideEvent)},beforeUnmount:function(e){document.body.removeEventListener("click",e.clickOutsideEvent)}}),Yt.mount("#app")},1038:function(e,t,n){e.exports=n.p+"img/add-cell.ef0d6f6e.svg"},4765:function(e,t,n){e.exports=n.p+"img/remove-cell.42315e5a.svg"},8611:function(e,t,n){e.exports=n.p+"img/selection.cb03e320.svg"}},t={};function n(i){var s=t[i];if(void 0!==s)return s.exports;var a=t[i]={exports:{}};return e[i](a,a.exports,n),a.exports}n.m=e,function(){var e=[];n.O=function(t,i,s,a){if(!i){var r=1/0;for(d=0;d<e.length;d++){i=e[d][0],s=e[d][1],a=e[d][2];for(var o=!0,l=0;l<i.length;l++)(!1&a||r>=a)&&Object.keys(n.O).every((function(e){return n.O[e](i[l])}))?i.splice(l--,1):(o=!1,a<r&&(r=a));if(o){e.splice(d--,1);var c=s();void 0!==c&&(t=c)}}return t}a=a||0;for(var d=e.length;d>0&&e[d-1][2]>a;d--)e[d]=e[d-1];e[d]=[i,s,a]}}(),function(){n.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return n.d(t,{a:t}),t}}(),function(){n.d=function(e,t){for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})}}(),function(){n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){n.p=""}(),function(){var e={143:0};n.O.j=function(t){return 0===e[t]};var t=function(t,i){var s,a,r=i[0],o=i[1],l=i[2],c=0;if(r.some((function(t){return 0!==e[t]}))){for(s in o)n.o(o,s)&&(n.m[s]=o[s]);if(l)var d=l(n)}for(t&&t(i);c<r.length;c++)a=r[c],n.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return n.O(d)},i=self["webpackChunkcybercells"]=self["webpackChunkcybercells"]||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))}();var i=n.O(void 0,[998],(function(){return n(7439)}));i=n.O(i)})();
//# sourceMappingURL=app.d8cfca28.js.map